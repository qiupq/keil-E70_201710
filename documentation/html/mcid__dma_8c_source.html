<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SAME70 Xplained Software Package: libraries/libchip/source/mcid_dma.c Source File</title>
<link href="common/style.css" rel="stylesheet" type="text/css"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
    <div id="body">
        <div id="title">  SAME70 Xplained Software Package 1.5</div>
        <div id="banner"></div>

<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="dir_81818f1c1b01098ad6d8389f2aaf9f72.html">libraries</a>      </li>
      <li><a class="el" href="dir_33c8d9ef0c748cf5c50df7dbf441839e.html">libchip</a>      </li>
      <li><a class="el" href="dir_bf64bf1d31205111dab559ea5953d43c.html">source</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>mcid_dma.c</h1>  </div>
</div>
<div class="contents">
<a href="mcid__dma_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* ---------------------------------------------------------------------------- */</span>
<a name="l00002"></a>00002 <span class="comment">/*                  Atmel Microcontroller Software Support                      */</span>
<a name="l00003"></a>00003 <span class="comment">/*                       SAM Software Package License                           */</span>
<a name="l00004"></a>00004 <span class="comment">/* ---------------------------------------------------------------------------- */</span>
<a name="l00005"></a>00005 <span class="comment">/* Copyright (c) 2015, Atmel Corporation                                        */</span>
<a name="l00006"></a>00006 <span class="comment">/*                                                                              */</span>
<a name="l00007"></a>00007 <span class="comment">/* All rights reserved.                                                         */</span>
<a name="l00008"></a>00008 <span class="comment">/*                                                                              */</span>
<a name="l00009"></a>00009 <span class="comment">/* Redistribution and use in source and binary forms, with or without           */</span>
<a name="l00010"></a>00010 <span class="comment">/* modification, are permitted provided that the following condition is met:    */</span>
<a name="l00011"></a>00011 <span class="comment">/*                                                                              */</span>
<a name="l00012"></a>00012 <span class="comment">/* - Redistributions of source code must retain the above copyright notice,     */</span>
<a name="l00013"></a>00013 <span class="comment">/* this list of conditions and the disclaimer below.                            */</span>
<a name="l00014"></a>00014 <span class="comment">/*                                                                              */</span>
<a name="l00015"></a>00015 <span class="comment">/* Atmel&#39;s name may not be used to endorse or promote products derived from     */</span>
<a name="l00016"></a>00016 <span class="comment">/* this software without specific prior written permission.                     */</span>
<a name="l00017"></a>00017 <span class="comment">/*                                                                              */</span>
<a name="l00018"></a>00018 <span class="comment">/* DISCLAIMER:  THIS SOFTWARE IS PROVIDED BY ATMEL &quot;AS IS&quot; AND ANY EXPRESS OR   */</span>
<a name="l00019"></a>00019 <span class="comment">/* IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF */</span>
<a name="l00020"></a>00020 <span class="comment">/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT ARE   */</span>
<a name="l00021"></a>00021 <span class="comment">/* DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT, INDIRECT,      */</span>
<a name="l00022"></a>00022 <span class="comment">/* INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT */</span>
<a name="l00023"></a>00023 <span class="comment">/* LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,  */</span>
<a name="l00024"></a>00024 <span class="comment">/* OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF    */</span>
<a name="l00025"></a>00025 <span class="comment">/* LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING         */</span>
<a name="l00026"></a>00026 <span class="comment">/* NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, */</span>
<a name="l00027"></a>00027 <span class="comment">/* EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                           */</span>
<a name="l00028"></a>00028 <span class="comment">/* ---------------------------------------------------------------------------- */</span>
<a name="l00029"></a>00029 <span class="comment"></span>
<a name="l00030"></a>00030 <span class="comment">/** \file</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> *  Implement for SD/MMC low level commands.</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> *  \sa \ref hsmci_module, \ref sdmmc_module</span>
<a name="l00035"></a>00035 <span class="comment"> */</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">/*----------------------------------------------------------------------------</span>
<a name="l00038"></a>00038 <span class="comment"> *         Headers</span>
<a name="l00039"></a>00039 <span class="comment"> *----------------------------------------------------------------------------*/</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="board_8h.html">board.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="sdmmc_8h.html">sdmmc.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">/*----------------------------------------------------------------------------</span>
<a name="l00047"></a>00047 <span class="comment"> *         Local constants</span>
<a name="l00048"></a>00048 <span class="comment"> *----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00049"></a>00049 <span class="comment">/** \addtorgoup mcid_defines</span>
<a name="l00050"></a>00050 <span class="comment"> *      @{*/</span>
<a name="l00051"></a>00051 <span class="comment"></span>
<a name="l00052"></a>00052 <span class="comment">/** Enable MCI */</span>
<a name="l00053"></a><a class="code" href="mcid__dma_8c.html#aaf10b2ffdc8da0b47ef6ae3401f4a1b5">00053</a> <span class="preprocessor">#define MCI_ENABLE(pMciHw)     HSMCI_Enable(pMciHw)</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="comment">/** Disable MCI */</span>
<a name="l00055"></a><a class="code" href="mcid__dma_8c.html#aa3adb1fa6fdb984ac86b81ea8bf55937">00055</a> <span class="preprocessor">#define MCI_DISABLE(pMciHw)    HSMCI_Disable(pMciHw)</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="comment">/** Reset MCI */</span>
<a name="l00057"></a><a class="code" href="mcid__dma_8c.html#adbfb1c85cace4fdec2f80ff0d76ad3b6">00057</a> <span class="preprocessor">#define MCI_RESET(pMciHw)      HSMCI_Reset(pMciHw, 0)</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00059"></a>00059 <span class="comment">/** Return halfword(16-bit) count from byte count */</span>
<a name="l00060"></a><a class="code" href="mcid__dma_8c.html#a96690c3ee578656a9165ca2644dd6cce">00060</a> <span class="preprocessor">#define toHWCOUNT(byteCnt) (((byteCnt)&amp;0x1) ? (((byteCnt)/2)+1) : ((byteCnt)/2))</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="comment">/** Return word(32-bit) count from byte count */</span>
<a name="l00062"></a><a class="code" href="mcid__dma_8c.html#aa0b81340336f47e2267e0dfd3991a761">00062</a> <span class="preprocessor">#define toWCOUNT(byteCnt)  (((byteCnt)&amp;0x3) ? (((byteCnt)/4)+1) : ((byteCnt)/4))</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a>00064 <span class="comment"></span>
<a name="l00065"></a>00065 <span class="comment">/** Bit mask for status register errors. */</span>
<a name="l00066"></a><a class="code" href="mcid__dma_8c.html#ab1a8025fbf9b28aee8d6e079b51e86d9">00066</a> <span class="preprocessor">#define STATUS_ERRORS ((uint32_t)(HSMCI_SR_UNRE  \</span>
<a name="l00067"></a>00067 <span class="preprocessor">                                  | HSMCI_SR_OVRE \</span>
<a name="l00068"></a>00068 <span class="preprocessor">                                  | HSMCI_SR_ACKRCVE \</span>
<a name="l00069"></a>00069 <span class="preprocessor">                                  | HSMCI_SR_CSTOE \</span>
<a name="l00070"></a>00070 <span class="preprocessor">                                  | HSMCI_SR_DTOE \</span>
<a name="l00071"></a>00071 <span class="preprocessor">                                  | HSMCI_SR_DCRCE \</span>
<a name="l00072"></a>00072 <span class="preprocessor">                                  | HSMCI_SR_RTOE \</span>
<a name="l00073"></a>00073 <span class="preprocessor">                                  | HSMCI_SR_RENDE \</span>
<a name="l00074"></a>00074 <span class="preprocessor">                                  | HSMCI_SR_RCRCE \</span>
<a name="l00075"></a>00075 <span class="preprocessor">                                  | HSMCI_SR_RDIRE \</span>
<a name="l00076"></a>00076 <span class="preprocessor">                                  | HSMCI_SR_RINDE))</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00078"></a>00078 <span class="comment">/** Bit mask for response errors */</span>
<a name="l00079"></a><a class="code" href="mcid__dma_8c.html#a16e047531ae7aff185d8a56401717992">00079</a> <span class="preprocessor">#define STATUS_ERRORS_RESP ((uint32_t)(HSMCI_SR_CSTOE \</span>
<a name="l00080"></a>00080 <span class="preprocessor">                                       | HSMCI_SR_RTOE \</span>
<a name="l00081"></a>00081 <span class="preprocessor">                                       | HSMCI_SR_RENDE \</span>
<a name="l00082"></a>00082 <span class="preprocessor">                                       | HSMCI_SR_RCRCE \</span>
<a name="l00083"></a>00083 <span class="preprocessor">                                       | HSMCI_SR_RDIRE \</span>
<a name="l00084"></a>00084 <span class="preprocessor">                                       | HSMCI_SR_RINDE))</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00086"></a>00086 <span class="comment">/** Bit mask for data errors */</span>
<a name="l00087"></a><a class="code" href="mcid__dma_8c.html#a8610e3e69bb627c21f924564154a2432">00087</a> <span class="preprocessor">#define STATUS_ERRORS_DATA ((uint32_t)(HSMCI_SR_UNRE \</span>
<a name="l00088"></a>00088 <span class="preprocessor">                                       | HSMCI_SR_OVRE \</span>
<a name="l00089"></a>00089 <span class="preprocessor">                                       | HSMCI_SR_DTOE \</span>
<a name="l00090"></a>00090 <span class="preprocessor">                                       | HSMCI_SR_DCRCE))</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00092"></a>00092 <span class="comment">/** Max DMA size in a single transfer */</span>
<a name="l00093"></a><a class="code" href="mcid__dma_8c.html#a941d6074126345e6acdf3d91ee305b11">00093</a> <span class="preprocessor">#define MAX_DMA_SIZE                (XDMAC_MAX_BT_SIZE &amp; 0xFFFFFF00)</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00095"></a>00095 <span class="comment">/** SD/MMC memory Single block */</span>
<a name="l00096"></a><a class="code" href="mcid__dma_8c.html#a89ac994f84d8e9b8a91a6174ab676cef">00096</a> <span class="preprocessor">#define _CMDR_SDMEM_SINGLE  \</span>
<a name="l00097"></a>00097 <span class="preprocessor">    (HSMCI_CMDR_TRCMD_START_DATA | HSMCI_CMDR_TRTYP_SINGLE)</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span><span class="comment">/** SD/MMC memory Multi block */</span>
<a name="l00099"></a><a class="code" href="mcid__dma_8c.html#a5768076a8ba20db64599e81d5a5c8c11">00099</a> <span class="preprocessor">#define _CMDR_SDMEM_MULTI   \</span>
<a name="l00100"></a>00100 <span class="preprocessor">    (HSMCI_CMDR_TRCMD_START_DATA | HSMCI_CMDR_TRTYP_MULTIPLE)</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span><span class="comment">/** SDIO byte transfer */</span>
<a name="l00102"></a><a class="code" href="mcid__dma_8c.html#a2ac6ad1d89b6beb197d04ca19f42975b">00102</a> <span class="preprocessor">#define _CMDR_SDIO_BYTE     \</span>
<a name="l00103"></a>00103 <span class="preprocessor">    (HSMCI_CMDR_TRCMD_START_DATA | HSMCI_CMDR_TRTYP_BYTE)</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span><span class="comment">/** SDIO block transfer */</span>
<a name="l00105"></a><a class="code" href="mcid__dma_8c.html#ad953989c7cced1d47aa0f3794544387d">00105</a> <span class="preprocessor">#define _CMDR_SDIO_BLOCK    \</span>
<a name="l00106"></a>00106 <span class="preprocessor">    (HSMCI_CMDR_TRCMD_START_DATA | HSMCI_CMDR_TRTYP_BLOCK)</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00108"></a>00108 <span class="comment">/**     @}*/</span>
<a name="l00109"></a>00109 <span class="comment">/*---------------------------------------------------------------------------</span>
<a name="l00110"></a>00110 <span class="comment"> *         Local types</span>
<a name="l00111"></a>00111 <span class="comment"> *---------------------------------------------------------------------------*/</span>
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 <span class="comment">/*----------------------------------------------------------------------------</span>
<a name="l00114"></a>00114 <span class="comment"> *         Local variable</span>
<a name="l00115"></a>00115 <span class="comment"> *----------------------------------------------------------------------------*/</span>
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="comment">//#define MCID_DBG  0</span>
<a name="l00118"></a>00118 <span class="comment">//static uint8_t bMcidDBG = 0;</span>
<a name="l00119"></a>00119 <span class="comment"></span>
<a name="l00120"></a>00120 <span class="comment">/** HAL for SD/MMC bus mode (MCI interface) */</span>
<a name="l00121"></a>00121 <span class="keyword">static</span> <a class="code" href="structs_sd_hal_functions.html" title="SD/MMC card HAL functions.">sSdHalFunctions</a> sdHal = {
<a name="l00122"></a>00122     (fSdmmcLock)<a class="code" href="group__mcid__functions.html#ga166b9dbbc64963a05679dc4a71ebe1b0">MCID_Lock</a>,
<a name="l00123"></a>00123     (<a class="code" href="group__sdmmc__hal__def.html#gab6962c4a37047d396b50d7268fa9c692">fSdmmcRelease</a>)MCID_Release,
<a name="l00124"></a>00124     (fSdmmcSendCommand)<a class="code" href="group__mcid__functions.html#ga71c682b80833894cc847b231139874d5">MCID_SendCmd</a>,
<a name="l00125"></a>00125     (<a class="code" href="group__sdmmc__hal__def.html#ga7185307199809cd9aad40eff26607989">fSdmmcIOCtrl</a>)<a class="code" href="group__mcid__functions.html#ga26e85daa2248e83129b01f755b1cfc0b">MCID_IOCtrl</a>
<a name="l00126"></a>00126 };
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <span class="comment">/*---------------------------------------------------------------------------</span>
<a name="l00129"></a>00129 <span class="comment"> *         Internal functions</span>
<a name="l00130"></a>00130 <span class="comment"> *---------------------------------------------------------------------------*/</span>
<a name="l00131"></a>00131 <span class="comment"></span>
<a name="l00132"></a>00132 <span class="comment">/** \addtogroup mcid_functions</span>
<a name="l00133"></a>00133 <span class="comment"> *@{</span>
<a name="l00134"></a>00134 <span class="comment"> */</span>
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="keyword">static</span> <span class="keywordtype">void</span> hsmci_callback(uint32_t channel, <a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid)
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138     channel = channel;
<a name="l00139"></a>00139     <a class="code" href="structs_sdmmc_command.html">sSdmmcCommand</a> *pCmd = pMcid-&gt;<a class="code" href="structs_mcid.html#a113e7e46d78a1cc63b5e47311198c0b5">pCmd</a>;
<a name="l00140"></a>00140     SCB_InvalidateDCache_by_Addr((uint32_t *)&amp;pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#af4475ca3a7a1fbd120f8e1635c07fdcd">pData</a>[0],
<a name="l00141"></a>00141                                  pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a> * pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a>);
<a name="l00142"></a>00142 }
<a name="l00143"></a>00143 <span class="comment"></span>
<a name="l00144"></a>00144 <span class="comment">/**</span>
<a name="l00145"></a>00145 <span class="comment"> * Enable MCI peripheral access clock</span>
<a name="l00146"></a>00146 <span class="comment"> */</span>
<a name="l00147"></a>00147 <span class="keyword">static</span> uint8_t _PeripheralEnable(uint32_t <span class="keywordtype">id</span>)
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149     <span class="keywordflow">if</span> (<a class="code" href="pmc_8c.html#a13d9ea02189cb126f06a7d9c7241314a" title="Get Periph Status for the given peripheral ID.">PMC_IsPeriphEnabled</a>(<span class="keywordtype">id</span>)) <span class="keywordflow">return</span> 0;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <a class="code" href="pmc_8c.html#a4154148b8d69545bca1b5c868c004d49" title="Enables the clock of a peripheral. The peripheral ID is used to identify which peripheral is targeted...">PMC_EnablePeripheral</a>(<span class="keywordtype">id</span>);
<a name="l00152"></a>00152     <span class="keywordflow">return</span> 1;
<a name="l00153"></a>00153 }
<a name="l00154"></a>00154 <span class="comment"></span>
<a name="l00155"></a>00155 <span class="comment">/**</span>
<a name="l00156"></a>00156 <span class="comment"> * HSMCI DMA R/W prepare</span>
<a name="l00157"></a>00157 <span class="comment"> */</span>
<a name="l00158"></a>00158 <span class="keyword">static</span> uint32_t _MciDMAPrepare(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid, uint8_t bRd)
<a name="l00159"></a>00159 {
<a name="l00160"></a>00160     <a class="code" href="structs_xdmad.html">sXdmad</a> *pXdmad = pMcid-&gt;<a class="code" href="structs_mcid.html#ab1ef95de31552207b5a74ee0c5f13112">pXdmad</a>;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     <span class="comment">/* Allocate a channel */</span>
<a name="l00163"></a>00163     <span class="keywordflow">if</span> (bRd) {
<a name="l00164"></a>00164         pMcid-&gt;<a class="code" href="structs_mcid.html#a420b0285bf591a6b63ab9083a824bb01">dwDmaCh</a> = <a class="code" href="group__dmad__functions.html#gaafb596e6912f388050a8ff98f54b8b8f" title="Allocate a XDMA channel for upper layer.">XDMAD_AllocateChannel</a>
<a name="l00165"></a>00165                          (pXdmad, pMcid-&gt;<a class="code" href="structs_mcid.html#a546ddd9ff24beec7e92544b0f5e3eafe">bID</a>, <a class="code" href="group__dmad__defines.html#gaf546b0494f9f0e949bf9bd7a37bbc82c">XDMAD_TRANSFER_MEMORY</a>);
<a name="l00166"></a>00166         <a class="code" href="group__dmad__functions.html#gaa0af49f87c84aaa20bee1f055d31ad2d" title="Set the callback function for xDMA channel transfer.">XDMAD_SetCallback</a>(pXdmad, pMcid-&gt;<a class="code" href="structs_mcid.html#a420b0285bf591a6b63ab9083a824bb01">dwDmaCh</a>, (<a class="code" href="group__dmad__structs.html#gad73084a7f0dbe02552288737859733bf">XdmadTransferCallback</a>)hsmci_callback,
<a name="l00167"></a>00167                           pMcid);
<a name="l00168"></a>00168     } <span class="keywordflow">else</span> {
<a name="l00169"></a>00169         pMcid-&gt;<a class="code" href="structs_mcid.html#a420b0285bf591a6b63ab9083a824bb01">dwDmaCh</a> = <a class="code" href="group__dmad__functions.html#gaafb596e6912f388050a8ff98f54b8b8f" title="Allocate a XDMA channel for upper layer.">XDMAD_AllocateChannel</a>
<a name="l00170"></a>00170                          (pXdmad, <a class="code" href="group__dmad__defines.html#gaf546b0494f9f0e949bf9bd7a37bbc82c">XDMAD_TRANSFER_MEMORY</a>, pMcid-&gt;<a class="code" href="structs_mcid.html#a546ddd9ff24beec7e92544b0f5e3eafe">bID</a>);
<a name="l00171"></a>00171         <a class="code" href="group__dmad__functions.html#gaa0af49f87c84aaa20bee1f055d31ad2d" title="Set the callback function for xDMA channel transfer.">XDMAD_SetCallback</a>(pXdmad, pMcid-&gt;<a class="code" href="structs_mcid.html#a420b0285bf591a6b63ab9083a824bb01">dwDmaCh</a>, NULL, NULL);
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="keywordflow">if</span> (pMcid-&gt;<a class="code" href="structs_mcid.html#a420b0285bf591a6b63ab9083a824bb01">dwDmaCh</a> == <a class="code" href="group__dmad__defines.html#gaaf241aab265afa0d7eb386c81ee42f41">XDMAD_ALLOC_FAILED</a>)
<a name="l00175"></a>00175         <span class="keywordflow">return</span> SDMMC_ERROR_BUSY;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <a class="code" href="group__dmad__functions.html#ga2a7947467c04eb39abee2471d846ee35" title="Enable clock of the xDMA peripheral, Enable the dma peripheral, configure configuration register for ...">XDMAD_PrepareChannel</a>(pXdmad, pMcid-&gt;<a class="code" href="structs_mcid.html#a420b0285bf591a6b63ab9083a824bb01">dwDmaCh</a>);
<a name="l00178"></a>00178     <span class="keywordflow">return</span> SDMMC_SUCCESS;
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 <span class="comment"></span>
<a name="l00181"></a>00181 <span class="comment">/**</span>
<a name="l00182"></a>00182 <span class="comment"> * HSMCI DMA R/W</span>
<a name="l00183"></a>00183 <span class="comment"> * \return 1 if DMA started.</span>
<a name="l00184"></a>00184 <span class="comment"> */</span>
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="comment">/* Linked lists for multi transfer buffer chaining structure instance. */</span>
<a name="l00187"></a><a class="code" href="group__mcid__functions.html#ga745dbddddd85ddbe2c71a9df4c3e38af">00187</a> <a class="code" href="group__sdmmc__api.html#ga745dbddddd85ddbe2c71a9df4c3e38af" title="xDMA interrupt handler.">COMPILER_ALIGNED</a>(32) static <a class="code" href="struct_linked_list_descripor_view1.html" title="Structure for storing parameters for DMA view1 that can be performed by the DMA Master transfer...">LinkedListDescriporView1</a> dmaLinkList[256];
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 static uint32_t _MciDMA(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid, uint32_t bFByte, uint8_t bRd)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191     <a class="code" href="struct_hsmci.html" title="Hsmci hardware registers.">Hsmci</a> *pHw = pMcid-&gt;pMciHw;
<a name="l00192"></a>00192     <a class="code" href="structs_xdmad.html">sXdmad</a> *pXdmad = pMcid-&gt;pXdmad;
<a name="l00193"></a>00193     <a class="code" href="structs_sdmmc_command.html">sSdmmcCommand</a> *pCmd = pMcid-&gt;pCmd;
<a name="l00194"></a>00194     <a class="code" href="structs_xdmad_cfg.html">sXdmadCfg</a> xdmadRxCfg, xdmadTxCfg;
<a name="l00195"></a>00195     uint32_t xdmaCndc, xdmaInt;
<a name="l00196"></a>00196     uint32_t hsmciId;
<a name="l00197"></a>00197     uint8_t i;
<a name="l00198"></a>00198     uint32_t totalSize = pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a> * pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a>;
<a name="l00199"></a>00199     uint32_t maxXSize;
<a name="l00200"></a>00200     uint32_t memAddress;
<a name="l00201"></a>00201     uint8_t  bMByte;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     <span class="keywordflow">if</span> (pMcid-&gt;dwXfrNdx &gt;= totalSize) <span class="keywordflow">return</span> 0;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     <span class="comment">/* Prepare DMA transfer */</span>
<a name="l00206"></a>00206     <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a> != 1) {
<a name="l00207"></a>00207         pMcid-&gt;dwXSize = totalSize - pMcid-&gt;dwXfrNdx;
<a name="l00208"></a>00208         hsmciId = ID_HSMCI;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <span class="keywordflow">if</span> (bRd) {
<a name="l00211"></a>00211             <span class="keywordflow">for</span> (i = 0; i &lt; pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a>; i++) {
<a name="l00212"></a>00212                 dmaLinkList[i].mbr_ubc = XDMA_UBC_NVIEW_NDV1
<a name="l00213"></a>00213                                          | ((i == pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a> - 1) ? 0 : XDMA_UBC_NDE_FETCH_EN)
<a name="l00214"></a>00214                                          | XDMA_UBC_NDEN_UPDATED
<a name="l00215"></a>00215                                          | pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a> / 4;
<a name="l00216"></a>00216                 dmaLinkList[i].mbr_sa  = (uint32_t) &amp; (pHw-&gt;<a class="code" href="struct_hsmci.html#aaac76481441afebd5c567d7aa8ef3c48" title="(Hsmci Offset: 0x200) FIFO Memory Aperture0">HSMCI_FIFO</a>[i]);
<a name="l00217"></a>00217                 dmaLinkList[i].mbr_da = (uint32_t)&amp;pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#af4475ca3a7a1fbd120f8e1635c07fdcd">pData</a>[i * pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a>];
<a name="l00218"></a>00218 
<a name="l00219"></a>00219                 if (i == pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a> - 1)
<a name="l00220"></a>00220                     dmaLinkList[i].mbr_nda = 0;
<a name="l00221"></a>00221                 <span class="keywordflow">else</span>
<a name="l00222"></a>00222                     dmaLinkList[i].mbr_nda = (uint32_t)&amp;dmaLinkList[ i + 1 ];
<a name="l00223"></a>00223 
<a name="l00224"></a>00224                 <span class="comment">//          SCB_CleanDCache_by_Addr((uint32_t *)&amp;dmaLinkList[i],sizeof(LinkedListDescriporView1));</span>
<a name="l00225"></a>00225             }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227             xdmadRxCfg.<a class="code" href="structs_xdmad_cfg.html#aef4b507de4383db9c3f9d378451e04ff">mbr_cfg</a> = <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga8175313f2e858a3b23a50ebd1ee85f97" title="(XDMAC_CC) Synchronized mode (Peripheral to Memory or Memory to Peripheral Transfer).">XDMAC_CC_TYPE_PER_TRAN</a>
<a name="l00228"></a>00228                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga91a0a7614a7704b1004adb0e12cfd0a4" title="(XDMAC_CC) The memory burst size is set to one.">XDMAC_CC_MBSIZE_SINGLE</a>
<a name="l00229"></a>00229                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga8ddf6e10d716d88c98149035c8776327" title="(XDMAC_CC) Peripheral to Memory transfer.">XDMAC_CC_DSYNC_PER2MEM</a>
<a name="l00230"></a>00230                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gadfc550597a28fe789a193c8f7e9a4d25" title="(XDMAC_CC) 1 data transferred">XDMAC_CC_CSIZE_CHK_1</a>
<a name="l00231"></a>00231                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga523464a842de59276f402ff354afb842" title="(XDMAC_CC) The data size is set to 32 bits">XDMAC_CC_DWIDTH_WORD</a>
<a name="l00232"></a>00232                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gacff293a7eb18e4912a853372ae98ba4a" title="(XDMAC_CC) The data is read through the system bus interface 1.">XDMAC_CC_SIF_AHB_IF1</a>
<a name="l00233"></a>00233                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga11a2da411e91fcc0b98cac79a06304f6" title="(XDMAC_CC) The data is written though the system bus interface 1.">XDMAC_CC_DIF_AHB_IF1</a>
<a name="l00234"></a>00234                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gafa77f5f1badd59939e7ef9ba02c0cbc4" title="(XDMAC_CC) The address remains unchanged.">XDMAC_CC_SAM_FIXED_AM</a>
<a name="l00235"></a>00235                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gad15f279fc4874f7d6c0701852a93d263" title="(XDMAC_CC) The addressing mode is incremented (the increment size is set to the data size)...">XDMAC_CC_DAM_INCREMENTED_AM</a>
<a name="l00236"></a>00236                                  | XDMAC_CC_PERID(<a class="code" href="xdma__hardware__interface_8c.html#a1c7e741165685b3e072aa75e4cfb1034" title="Get peripheral identifier coded for hardware handshaking interface.">XDMAIF_Get_ChannelNumber</a>
<a name="l00237"></a>00237                                                   (hsmciId, XDMAD_TRANSFER_RX));
<a name="l00238"></a>00238             xdmaCndc = <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga8b0ff8d823fd68f53a43ca311ff2b5de" title="(XDMAC_CNDC) Next Descriptor View 1">XDMAC_CNDC_NDVIEW_NDV1</a>
<a name="l00239"></a>00239                        | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gaeaeb9d5224f924feb90a0cb02f6f424f" title="(XDMAC_CNDC) Descriptor fetch is enabled.">XDMAC_CNDC_NDE_DSCR_FETCH_EN</a>
<a name="l00240"></a>00240                        | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga497755c8c9290f3435423707b0fefb16" title="(XDMAC_CNDC) Source parameters are updated when the descriptor is retrieved.">XDMAC_CNDC_NDSUP_SRC_PARAMS_UPDATED</a>
<a name="l00241"></a>00241                        | XDMAC_CNDC_NDDUP_DST_PARAMS_UPDATED;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 
<a name="l00244"></a>00244             <span class="keywordflow">if</span> (<a class="code" href="group__dmad__functions.html#ga075cce3b88af1fff5064218720811fc0" title="Configure DMA for a single transfer.">XDMAD_ConfigureTransfer</a>(pXdmad, pMcid-&gt;dwDmaCh,
<a name="l00245"></a>00245                                          &amp;xdmadRxCfg, xdmaCndc, (uint32_t)&amp;dmaLinkList[0],
<a name="l00246"></a>00246                                          <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga058a8827be674bd84936308adce6ae4e" title="(XDMAC_CIE) End of Linked List Interrupt Enable Bit">XDMAC_CIE_LIE</a>))
<a name="l00247"></a>00247                 <span class="keywordflow">return</span> 0;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249             SCB_CleanDCache_by_Addr((uint32_t *)dmaLinkList, <span class="keyword">sizeof</span>(dmaLinkList));
<a name="l00250"></a>00250 
<a name="l00251"></a>00251             <span class="keywordflow">if</span> (<a class="code" href="group__dmad__functions.html#ga20bc2d5f85c7145a43d7ccd13b067e50" title="Start xDMA transfer.">XDMAD_StartTransfer</a>(pXdmad, pMcid-&gt;dwDmaCh))
<a name="l00252"></a>00252                 <span class="keywordflow">return</span> 0;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254             <span class="comment">//Write</span>
<a name="l00255"></a>00255         } <span class="keywordflow">else</span> {
<a name="l00256"></a>00256             <span class="keywordflow">for</span> (i = 0; i &lt; pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a>; i++) {
<a name="l00257"></a>00257                 dmaLinkList[i].mbr_ubc = XDMA_UBC_NVIEW_NDV1
<a name="l00258"></a>00258                                          | ((i == pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a> - 1) ? 0 : XDMA_UBC_NDE_FETCH_EN)
<a name="l00259"></a>00259                                          | XDMA_UBC_NDEN_UPDATED
<a name="l00260"></a>00260                                          | pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a> / 4;
<a name="l00261"></a>00261                 dmaLinkList[i].mbr_sa = (uint32_t)&amp;pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#af4475ca3a7a1fbd120f8e1635c07fdcd">pData</a>[i * pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a>];
<a name="l00262"></a>00262                 dmaLinkList[i].mbr_da = (uint32_t) &amp; (pHw-&gt;<a class="code" href="struct_hsmci.html#aaac76481441afebd5c567d7aa8ef3c48" title="(Hsmci Offset: 0x200) FIFO Memory Aperture0">HSMCI_FIFO</a>[i]);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264                 <span class="comment">// cache maintenance</span>
<a name="l00265"></a>00265                 <span class="comment">//      SCB_CleanDCache_by_Addr((uint32_t *)&amp;pCmd-&gt;pData[i * pCmd-&gt;wBlockSize],pCmd-&gt;wBlockSize);</span>
<a name="l00266"></a>00266                 <span class="keywordflow">if</span> (i == pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a> - 1) dmaLinkList[i].mbr_nda = 0;
<a name="l00267"></a>00267                 <span class="keywordflow">else</span> dmaLinkList[i].mbr_nda = (uint32_t)&amp;dmaLinkList[ i + 1 ];
<a name="l00268"></a>00268 
<a name="l00269"></a>00269                 <span class="comment">//      SCB_CleanDCache_by_Addr((uint32_t *)&amp;dmaLinkList[i],sizeof(LinkedListDescriporView1));</span>
<a name="l00270"></a>00270 
<a name="l00271"></a>00271             }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273             xdmadTxCfg.<a class="code" href="structs_xdmad_cfg.html#aef4b507de4383db9c3f9d378451e04ff">mbr_cfg</a> = <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga8175313f2e858a3b23a50ebd1ee85f97" title="(XDMAC_CC) Synchronized mode (Peripheral to Memory or Memory to Peripheral Transfer).">XDMAC_CC_TYPE_PER_TRAN</a>
<a name="l00274"></a>00274                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga91a0a7614a7704b1004adb0e12cfd0a4" title="(XDMAC_CC) The memory burst size is set to one.">XDMAC_CC_MBSIZE_SINGLE</a>
<a name="l00275"></a>00275                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gaa7c2daa13545869c378a2b039dffe059" title="(XDMAC_CC) Memory to Peripheral transfer.">XDMAC_CC_DSYNC_MEM2PER</a>
<a name="l00276"></a>00276                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gadfc550597a28fe789a193c8f7e9a4d25" title="(XDMAC_CC) 1 data transferred">XDMAC_CC_CSIZE_CHK_1</a>
<a name="l00277"></a>00277                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga523464a842de59276f402ff354afb842" title="(XDMAC_CC) The data size is set to 32 bits">XDMAC_CC_DWIDTH_WORD</a>
<a name="l00278"></a>00278                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gacff293a7eb18e4912a853372ae98ba4a" title="(XDMAC_CC) The data is read through the system bus interface 1.">XDMAC_CC_SIF_AHB_IF1</a>
<a name="l00279"></a>00279                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga11a2da411e91fcc0b98cac79a06304f6" title="(XDMAC_CC) The data is written though the system bus interface 1.">XDMAC_CC_DIF_AHB_IF1</a>
<a name="l00280"></a>00280                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga3d5947323f2c8784eb492be5529d423d" title="(XDMAC_CC) The addressing mode is incremented (the increment size is set to the data size)...">XDMAC_CC_SAM_INCREMENTED_AM</a>
<a name="l00281"></a>00281                                  | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gaa67fa62051302ee1b41b7cef806ffc10" title="(XDMAC_CC) The address remains unchanged.">XDMAC_CC_DAM_FIXED_AM</a>
<a name="l00282"></a>00282                                  | XDMAC_CC_PERID(<a class="code" href="xdma__hardware__interface_8c.html#a1c7e741165685b3e072aa75e4cfb1034" title="Get peripheral identifier coded for hardware handshaking interface.">XDMAIF_Get_ChannelNumber</a>(hsmciId, XDMAD_TRANSFER_TX));
<a name="l00283"></a>00283             xdmaCndc = <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga8b0ff8d823fd68f53a43ca311ff2b5de" title="(XDMAC_CNDC) Next Descriptor View 1">XDMAC_CNDC_NDVIEW_NDV1</a>
<a name="l00284"></a>00284                        | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gaeaeb9d5224f924feb90a0cb02f6f424f" title="(XDMAC_CNDC) Descriptor fetch is enabled.">XDMAC_CNDC_NDE_DSCR_FETCH_EN</a>
<a name="l00285"></a>00285                        | <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga497755c8c9290f3435423707b0fefb16" title="(XDMAC_CNDC) Source parameters are updated when the descriptor is retrieved.">XDMAC_CNDC_NDSUP_SRC_PARAMS_UPDATED</a>
<a name="l00286"></a>00286                        | XDMAC_CNDC_NDDUP_DST_PARAMS_UPDATED;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288             <span class="keywordflow">if</span> (<a class="code" href="group__dmad__functions.html#ga075cce3b88af1fff5064218720811fc0" title="Configure DMA for a single transfer.">XDMAD_ConfigureTransfer</a>(pXdmad, pMcid-&gt;dwDmaCh,
<a name="l00289"></a>00289                                          &amp;xdmadTxCfg, xdmaCndc, (uint32_t)&amp;dmaLinkList[0],
<a name="l00290"></a>00290                                          <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga058a8827be674bd84936308adce6ae4e" title="(XDMAC_CIE) End of Linked List Interrupt Enable Bit">XDMAC_CIE_LIE</a>))
<a name="l00291"></a>00291                 <span class="keywordflow">return</span> 0;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293             SCB_CleanDCache_by_Addr((uint32_t *)&amp;pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#af4475ca3a7a1fbd120f8e1635c07fdcd">pData</a>[0],
<a name="l00294"></a>00294                                     pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a> * pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a>);
<a name="l00295"></a>00295             SCB_CleanDCache_by_Addr((uint32_t *)dmaLinkList, <span class="keyword">sizeof</span>(dmaLinkList));
<a name="l00296"></a>00296 
<a name="l00297"></a>00297             <span class="keywordflow">if</span> (<a class="code" href="group__dmad__functions.html#ga20bc2d5f85c7145a43d7ccd13b067e50" title="Start xDMA transfer.">XDMAD_StartTransfer</a>(pXdmad, pMcid-&gt;dwDmaCh))
<a name="l00298"></a>00298                 <span class="keywordflow">return</span> 0;
<a name="l00299"></a>00299         }
<a name="l00300"></a>00300     } <span class="keywordflow">else</span> {
<a name="l00301"></a>00301         <span class="comment">/* Memory address and alignment */</span>
<a name="l00302"></a>00302         memAddress = (uint32_t)&amp;pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#af4475ca3a7a1fbd120f8e1635c07fdcd">pData</a>[pMcid-&gt;dwXfrNdx];
<a name="l00303"></a>00303         bMByte = bFByte ? 1 : (((memAddress &amp; 0x3) || (totalSize &amp; 0x3)));
<a name="l00304"></a>00304 
<a name="l00305"></a>00305         <span class="comment">/* P to M: Max size is P size */</span>
<a name="l00306"></a>00306         <span class="keywordflow">if</span> (bRd)
<a name="l00307"></a>00307             maxXSize = bFByte ? <a class="code" href="mcid__dma_8c.html#a941d6074126345e6acdf3d91ee305b11">MAX_DMA_SIZE</a> : (<a class="code" href="mcid__dma_8c.html#a941d6074126345e6acdf3d91ee305b11">MAX_DMA_SIZE</a> * 4);
<a name="l00308"></a>00308         <span class="keywordflow">else</span> {
<a name="l00309"></a>00309             <span class="comment">/* M to P: Max size is M size */</span>
<a name="l00310"></a>00310             maxXSize = bMByte ? <a class="code" href="mcid__dma_8c.html#a941d6074126345e6acdf3d91ee305b11">MAX_DMA_SIZE</a> : (<a class="code" href="mcid__dma_8c.html#a941d6074126345e6acdf3d91ee305b11">MAX_DMA_SIZE</a> * 4);
<a name="l00311"></a>00311         }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313         <span class="comment">/* Update index */</span>
<a name="l00314"></a>00314         pMcid-&gt;dwXSize = totalSize - pMcid-&gt;dwXfrNdx;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         <span class="keywordflow">if</span> (pMcid-&gt;dwXSize &gt; maxXSize)
<a name="l00317"></a>00317             pMcid-&gt;dwXSize = maxXSize;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319         <span class="comment">/* Prepare DMA transfer */</span>
<a name="l00320"></a>00320         <span class="keywordflow">if</span> (bRd) {
<a name="l00321"></a>00321             xdmadRxCfg.<a class="code" href="structs_xdmad_cfg.html#a61a9a3c0bec95ffe61fe74f065660da0">mbr_ubc</a> = bFByte ? pMcid-&gt;dwXSize : <a class="code" href="mcid__dma_8c.html#aa0b81340336f47e2267e0dfd3991a761">toWCOUNT</a>(pMcid-&gt;dwXSize);
<a name="l00322"></a>00322             xdmadRxCfg.<a class="code" href="structs_xdmad_cfg.html#aef313b84adfe87b2ffedc064523d0043">mbr_sa</a> = (uint32_t) &amp; (pHw-&gt;<a class="code" href="struct_hsmci.html#ae2fa33721d0b087e1ad987375166a51d" title="(Hsmci Offset: 0x30) Receive Data Register">HSMCI_RDR</a>);
<a name="l00323"></a>00323             xdmadRxCfg.<a class="code" href="structs_xdmad_cfg.html#a39424f282cf45c5fa984162c0d6971db">mbr_da</a> = (uint32_t)memAddress;
<a name="l00324"></a>00324             xdmadRxCfg.<a class="code" href="structs_xdmad_cfg.html#aef4b507de4383db9c3f9d378451e04ff">mbr_cfg</a> = <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga8175313f2e858a3b23a50ebd1ee85f97" title="(XDMAC_CC) Synchronized mode (Peripheral to Memory or Memory to Peripheral Transfer).">XDMAC_CC_TYPE_PER_TRAN</a> |
<a name="l00325"></a>00325                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga5f63b116e8b572784fcb0ad545241965" title="(XDMAC_CC) Memset is not activated.">XDMAC_CC_MEMSET_NORMAL_MODE</a> |
<a name="l00326"></a>00326                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga8ddf6e10d716d88c98149035c8776327" title="(XDMAC_CC) Peripheral to Memory transfer.">XDMAC_CC_DSYNC_PER2MEM</a> |
<a name="l00327"></a>00327                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gadfc550597a28fe789a193c8f7e9a4d25" title="(XDMAC_CC) 1 data transferred">XDMAC_CC_CSIZE_CHK_1</a> |
<a name="l00328"></a>00328                                  (bFByte ? <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga859823c8584c1743b5b1395819a38a59" title="(XDMAC_CC) The data size is set to 8 bits">XDMAC_CC_DWIDTH_BYTE</a> : XDMAC_CC_DWIDTH_WORD) |
<a name="l00329"></a>00329                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gacff293a7eb18e4912a853372ae98ba4a" title="(XDMAC_CC) The data is read through the system bus interface 1.">XDMAC_CC_SIF_AHB_IF1</a> |
<a name="l00330"></a>00330                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga11a2da411e91fcc0b98cac79a06304f6" title="(XDMAC_CC) The data is written though the system bus interface 1.">XDMAC_CC_DIF_AHB_IF1</a> |
<a name="l00331"></a>00331                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gafa77f5f1badd59939e7ef9ba02c0cbc4" title="(XDMAC_CC) The address remains unchanged.">XDMAC_CC_SAM_FIXED_AM</a> |
<a name="l00332"></a>00332                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gad15f279fc4874f7d6c0701852a93d263" title="(XDMAC_CC) The addressing mode is incremented (the increment size is set to the data size)...">XDMAC_CC_DAM_INCREMENTED_AM</a>;
<a name="l00333"></a>00333             xdmadRxCfg.<a class="code" href="structs_xdmad_cfg.html#ab7bb8f4c5ae357d4b62a1a48f9436f82">mbr_bc</a> = 0;
<a name="l00334"></a>00334             xdmaInt =  (<a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga28888770dda6ebc12764a57884c4604d" title="(XDMAC_CIE) End of Block Interrupt Enable Bit">XDMAC_CIE_BIE</a>   |
<a name="l00335"></a>00335                         <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gae3f5676f473fd65f4a1fed9ea087a1fb" title="(XDMAC_CIE) End of Disable Interrupt Enable Bit">XDMAC_CIE_DIE</a>   |
<a name="l00336"></a>00336                         <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga7b8a1c08bd202731261e381e478fa72e" title="(XDMAC_CIE) End of Flush Interrupt Enable Bit">XDMAC_CIE_FIE</a>   |
<a name="l00337"></a>00337                         <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gaf809a1f9e43204dae9a5dd38b195dcfe" title="(XDMAC_CIE) Read Bus Error Interrupt Enable Bit">XDMAC_CIE_RBIE</a>  |
<a name="l00338"></a>00338                         <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gab24f7e736cb58f52c2296827489d7b83" title="(XDMAC_CIE) Write Bus Error Interrupt Enable Bit">XDMAC_CIE_WBIE</a>  |
<a name="l00339"></a>00339                         XDMAC_CIE_ROIE);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341             <a class="code" href="group__dmad__functions.html#ga075cce3b88af1fff5064218720811fc0" title="Configure DMA for a single transfer.">XDMAD_ConfigureTransfer</a>(pXdmad, pMcid-&gt;dwDmaCh, &amp;xdmadRxCfg,
<a name="l00342"></a>00342                                      0, 0, xdmaInt);
<a name="l00343"></a>00343         } <span class="keywordflow">else</span> {
<a name="l00344"></a>00344             SCB_CleanDCache_by_Addr((uint32_t *)memAddress, pMcid-&gt;dwXSize);
<a name="l00345"></a>00345             xdmadTxCfg.<a class="code" href="structs_xdmad_cfg.html#a61a9a3c0bec95ffe61fe74f065660da0">mbr_ubc</a> = bFByte ? pMcid-&gt;dwXSize : <a class="code" href="mcid__dma_8c.html#aa0b81340336f47e2267e0dfd3991a761">toWCOUNT</a>(pMcid-&gt;dwXSize);
<a name="l00346"></a>00346             xdmadTxCfg.<a class="code" href="structs_xdmad_cfg.html#aef313b84adfe87b2ffedc064523d0043">mbr_sa</a> = (uint32_t)memAddress;
<a name="l00347"></a>00347             xdmadTxCfg.<a class="code" href="structs_xdmad_cfg.html#a39424f282cf45c5fa984162c0d6971db">mbr_da</a> = (uint32_t) &amp; (pHw-&gt;<a class="code" href="struct_hsmci.html#ae2acc8fa5c27537de564b745cc15dbc3" title="(Hsmci Offset: 0x34) Transmit Data Register">HSMCI_TDR</a>);
<a name="l00348"></a>00348             xdmadTxCfg.<a class="code" href="structs_xdmad_cfg.html#aef4b507de4383db9c3f9d378451e04ff">mbr_cfg</a> = <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga8175313f2e858a3b23a50ebd1ee85f97" title="(XDMAC_CC) Synchronized mode (Peripheral to Memory or Memory to Peripheral Transfer).">XDMAC_CC_TYPE_PER_TRAN</a> |
<a name="l00349"></a>00349                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga5f63b116e8b572784fcb0ad545241965" title="(XDMAC_CC) Memset is not activated.">XDMAC_CC_MEMSET_NORMAL_MODE</a> |
<a name="l00350"></a>00350                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gaa7c2daa13545869c378a2b039dffe059" title="(XDMAC_CC) Memory to Peripheral transfer.">XDMAC_CC_DSYNC_MEM2PER</a> |
<a name="l00351"></a>00351                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gadfc550597a28fe789a193c8f7e9a4d25" title="(XDMAC_CC) 1 data transferred">XDMAC_CC_CSIZE_CHK_1</a> |
<a name="l00352"></a>00352                                  (bFByte ? <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga859823c8584c1743b5b1395819a38a59" title="(XDMAC_CC) The data size is set to 8 bits">XDMAC_CC_DWIDTH_BYTE</a> : XDMAC_CC_DWIDTH_WORD) |
<a name="l00353"></a>00353                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gacff293a7eb18e4912a853372ae98ba4a" title="(XDMAC_CC) The data is read through the system bus interface 1.">XDMAC_CC_SIF_AHB_IF1</a> |
<a name="l00354"></a>00354                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga11a2da411e91fcc0b98cac79a06304f6" title="(XDMAC_CC) The data is written though the system bus interface 1.">XDMAC_CC_DIF_AHB_IF1</a> |
<a name="l00355"></a>00355                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga3d5947323f2c8784eb492be5529d423d" title="(XDMAC_CC) The addressing mode is incremented (the increment size is set to the data size)...">XDMAC_CC_SAM_INCREMENTED_AM</a> |
<a name="l00356"></a>00356                                  <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gaa67fa62051302ee1b41b7cef806ffc10" title="(XDMAC_CC) The address remains unchanged.">XDMAC_CC_DAM_FIXED_AM</a>;
<a name="l00357"></a>00357             xdmadTxCfg.<a class="code" href="structs_xdmad_cfg.html#ab7bb8f4c5ae357d4b62a1a48f9436f82">mbr_bc</a> = 0;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359             xdmaInt =  (<a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga28888770dda6ebc12764a57884c4604d" title="(XDMAC_CIE) End of Block Interrupt Enable Bit">XDMAC_CIE_BIE</a>   |
<a name="l00360"></a>00360                         <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gae3f5676f473fd65f4a1fed9ea087a1fb" title="(XDMAC_CIE) End of Disable Interrupt Enable Bit">XDMAC_CIE_DIE</a>   |
<a name="l00361"></a>00361                         <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#ga7b8a1c08bd202731261e381e478fa72e" title="(XDMAC_CIE) End of Flush Interrupt Enable Bit">XDMAC_CIE_FIE</a>   |
<a name="l00362"></a>00362                         <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gaf809a1f9e43204dae9a5dd38b195dcfe" title="(XDMAC_CIE) Read Bus Error Interrupt Enable Bit">XDMAC_CIE_RBIE</a>  |
<a name="l00363"></a>00363                         <a class="code" href="group___s_a_m_e70___x_d_m_a_c.html#gab24f7e736cb58f52c2296827489d7b83" title="(XDMAC_CIE) Write Bus Error Interrupt Enable Bit">XDMAC_CIE_WBIE</a>  |
<a name="l00364"></a>00364                         XDMAC_CIE_ROIE);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366             <a class="code" href="group__dmad__functions.html#ga075cce3b88af1fff5064218720811fc0" title="Configure DMA for a single transfer.">XDMAD_ConfigureTransfer</a>(pXdmad, pMcid-&gt;dwDmaCh, &amp;xdmadTxCfg,
<a name="l00367"></a>00367                                      0, 0, xdmaInt);
<a name="l00368"></a>00368         }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370         <a class="code" href="group__dmad__functions.html#ga20bc2d5f85c7145a43d7ccd13b067e50" title="Start xDMA transfer.">XDMAD_StartTransfer</a>(pXdmad, pMcid-&gt;dwDmaCh);
<a name="l00371"></a>00371     }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373     <span class="keywordflow">return</span> 1;
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 <span class="comment">/*----------------------------------------------------------------------------</span>
<a name="l00377"></a>00377 <span class="comment"> *         Local functions</span>
<a name="l00378"></a>00378 <span class="comment"> *----------------------------------------------------------------------------*/</span>
<a name="l00379"></a>00379 <span class="comment"></span>
<a name="l00380"></a>00380 <span class="comment">/**</span>
<a name="l00381"></a>00381 <span class="comment"> * Reset MCI HW interface and disable it.</span>
<a name="l00382"></a>00382 <span class="comment"> * \param keepSettings Keep old register settings, including</span>
<a name="l00383"></a>00383 <span class="comment"> *                     _MR, _SDCR, _DTOR, _CSTOR, _DMA and _CFG.</span>
<a name="l00384"></a>00384 <span class="comment"> */</span>
<a name="l00385"></a>00385 <span class="keyword">static</span> <span class="keywordtype">void</span> MCI_Reset(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMci, uint8_t keepSettings)
<a name="l00386"></a>00386 {
<a name="l00387"></a>00387     <a class="code" href="struct_hsmci.html" title="Hsmci hardware registers.">Hsmci</a> *pMciHw = pMci-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     assert(pMci);
<a name="l00390"></a>00390     assert(pMci-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>);
<a name="l00391"></a>00391 
<a name="l00392"></a>00392     <a class="code" href="group__hsmci__functions.html#ga0f8d0807a99a07f6d859633b77d062b2" title="Reset (&amp;amp; Disable) Multi-Media Interface.">HSMCI_Reset</a>(pMciHw, keepSettings);
<a name="l00393"></a>00393 }
<a name="l00394"></a>00394 <span class="comment"></span>
<a name="l00395"></a>00395 <span class="comment">/**</span>
<a name="l00396"></a>00396 <span class="comment"> * Configure the  MCI CLKDIV in the MCI_MR register. The max. for MCI clock is</span>
<a name="l00397"></a>00397 <span class="comment"> * MCK/2 and corresponds to CLKDIV = 0</span>
<a name="l00398"></a>00398 <span class="comment"> * \param pMci  Pointer to the low level MCI driver.</span>
<a name="l00399"></a>00399 <span class="comment"> * \param mciSpeed  MCI clock speed in Hz, 0 will not change current speed.</span>
<a name="l00400"></a>00400 <span class="comment"> * \param mck       MCK to generate MCI Clock, in Hz</span>
<a name="l00401"></a>00401 <span class="comment"> * \return The actual speed used, 0 for fail.</span>
<a name="l00402"></a>00402 <span class="comment"> */</span>
<a name="l00403"></a>00403 <span class="keyword">static</span> uint32_t MCI_SetSpeed(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMci, uint32_t mciSpeed, uint32_t mck)
<a name="l00404"></a>00404 {
<a name="l00405"></a>00405     <a class="code" href="struct_hsmci.html" title="Hsmci hardware registers.">Hsmci</a> *pMciHw = pMci-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>;
<a name="l00406"></a>00406     uint32_t clkdiv;
<a name="l00407"></a>00407     assert(pMci);
<a name="l00408"></a>00408     assert(pMciHw);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <span class="keywordflow">if</span> ((mck % mciSpeed) == 0)
<a name="l00411"></a>00411         clkdiv = mck / mciSpeed;
<a name="l00412"></a>00412     <span class="keywordflow">else</span>
<a name="l00413"></a>00413         clkdiv = ((mck + mciSpeed) / mciSpeed);
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     mciSpeed = mck / clkdiv;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     <span class="comment">/* Modify MR */</span>
<a name="l00418"></a>00418     <a class="code" href="group__hsmci__functions.html#ga3aa96ac076372bb4b34fe58c10640f7a" title="Set Clock Divider &amp;amp; Power save divider for MCI.">HSMCI_DivCtrl</a>(pMciHw, clkdiv, 0x7);
<a name="l00419"></a>00419     <span class="keywordflow">return</span> (mciSpeed);
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 <span class="comment"></span>
<a name="l00422"></a>00422 <span class="comment">/**</span>
<a name="l00423"></a>00423 <span class="comment">*/</span>
<a name="l00424"></a>00424 <span class="keyword">static</span> <span class="keywordtype">void</span> _FinishCmd(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid, uint8_t <a class="code" href="cciddriver_8h.html#ac87a621b6b29f2322c10bf0e0ee7e471">bStatus</a>)
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426     <a class="code" href="structs_sdmmc_command.html">sSdmmcCommand</a> *pCmd = pMcid-&gt;<a class="code" href="structs_mcid.html#a113e7e46d78a1cc63b5e47311198c0b5">pCmd</a>;
<a name="l00427"></a>00427     <a class="code" href="structs_xdmad.html">sXdmad</a> *pXdmad = pMcid-&gt;<a class="code" href="structs_mcid.html#ab1ef95de31552207b5a74ee0c5f13112">pXdmad</a>;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     <span class="comment">//uint32_t memAddress;</span>
<a name="l00430"></a>00430     <span class="comment">/* Release DMA channel (if used) */</span>
<a name="l00431"></a>00431     <span class="keywordflow">if</span> (pMcid-&gt;<a class="code" href="structs_mcid.html#a420b0285bf591a6b63ab9083a824bb01">dwDmaCh</a> != <a class="code" href="group__dmad__defines.html#gaaf241aab265afa0d7eb386c81ee42f41">XDMAD_ALLOC_FAILED</a>) {
<a name="l00432"></a>00432         <span class="keywordflow">if</span> (<a class="code" href="group__dmad__functions.html#ga2a3178c1d2615b7a4d7a0005662cdd89" title="Free the specified xDMA channel.">XDMAD_FreeChannel</a>(pXdmad, pMcid-&gt;<a class="code" href="structs_mcid.html#a420b0285bf591a6b63ab9083a824bb01">dwDmaCh</a>)) {
<a name="l00433"></a>00433             TRACE_ERROR(<span class="stringliteral">&quot; Can&#39;t free channel \n\r&quot;</span>);
<a name="l00434"></a>00434             <a class="code" href="trace_8h.html#a67a8f9bc74358aa21745a76e23768dae">TRACE_DEBUG</a>(<span class="stringliteral">&quot; Channel is in %d state\n\r&quot;</span>,
<a name="l00435"></a>00435                         pXdmad-&gt;XdmaChannels[pMcid-&gt;<a class="code" href="structs_mcid.html#a420b0285bf591a6b63ab9083a824bb01">dwDmaCh</a>].<a class="code" href="structs_xdmad_channel.html#ab1252d621e185b893da94c776129e9b8">state</a>);
<a name="l00436"></a>00436         }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438         pMcid-&gt;<a class="code" href="structs_mcid.html#a420b0285bf591a6b63ab9083a824bb01">dwDmaCh</a> = XDMAD_ALLOC_FAILED;
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     <span class="comment">/* Release command */</span>
<a name="l00442"></a>00442     pMcid-&gt;<a class="code" href="structs_mcid.html#a113e7e46d78a1cc63b5e47311198c0b5">pCmd</a>   = NULL;
<a name="l00443"></a>00443     pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> = MCID_LOCKED;
<a name="l00444"></a>00444     pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#aaf9241225f75ddfad39d1652695e7d6f">bStatus</a> = bStatus;
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <span class="comment">/* Invoke callback */</span>
<a name="l00447"></a>00447     <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#abeb62039643649f0482e5f4bd380aa5b">fCallback</a>)
<a name="l00448"></a>00448         (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#abeb62039643649f0482e5f4bd380aa5b">fCallback</a>)(pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#aaf9241225f75ddfad39d1652695e7d6f">bStatus</a>, pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a2f14adf3fed44ae0f898cff8a7d89aa7">pArg</a>);
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 <span class="comment">/*---------------------------------------------------------------------------</span>
<a name="l00452"></a>00452 <span class="comment"> *      Exported functions</span>
<a name="l00453"></a>00453 <span class="comment"> *---------------------------------------------------------------------------*/</span>
<a name="l00454"></a>00454 <span class="comment"></span>
<a name="l00455"></a>00455 <span class="comment">/**</span>
<a name="l00456"></a>00456 <span class="comment"> * Select MCI slot.</span>
<a name="l00457"></a>00457 <span class="comment"> */</span>
<a name="l00458"></a><a class="code" href="group__mcid__functions.html#gaac22cefb141ea222a6f86527fe00ec7f">00458</a> <span class="keywordtype">void</span> <a class="code" href="group__mcid__functions.html#gaac22cefb141ea222a6f86527fe00ec7f">MCID_SetSlot</a>(<a class="code" href="struct_hsmci.html" title="Hsmci hardware registers.">Hsmci</a> *pMci, uint8_t slot)
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 {
<a name="l00461"></a>00461     <a class="code" href="group__hsmci__functions.html#gaa994954a36c86927aa59db8b8737c47f" title="Set slot.">HSMCI_SetSlot</a>(pMci, slot);
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 <span class="comment"></span>
<a name="l00464"></a>00464 <span class="comment">/**</span>
<a name="l00465"></a>00465 <span class="comment"> * Initialize MCI driver.</span>
<a name="l00466"></a>00466 <span class="comment"> */</span>
<a name="l00467"></a><a class="code" href="group__mcid__functions.html#gacddd87e745fbdbff2826b44c188b867f">00467</a> <span class="keywordtype">void</span> <a class="code" href="group__mcid__functions.html#gacddd87e745fbdbff2826b44c188b867f">MCID_Init</a>(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid,
<a name="l00468"></a>00468                <a class="code" href="struct_hsmci.html" title="Hsmci hardware registers.">Hsmci</a> *pMci, uint8_t bID, uint32_t dwMck,
<a name="l00469"></a>00469                <a class="code" href="structs_xdmad.html">sXdmad</a> *pXdmad,
<a name="l00470"></a>00470                uint8_t bPolling)
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472     uint16_t clkDiv;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     assert(pMcid);
<a name="l00475"></a>00475     assert(pMci);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     <span class="comment">/* Initialize driver struct */</span>
<a name="l00478"></a>00478     pMcid-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>    = pMci;
<a name="l00479"></a>00479     pMcid-&gt;<a class="code" href="structs_mcid.html#a113e7e46d78a1cc63b5e47311198c0b5">pCmd</a>      = NULL;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     pMcid-&gt;<a class="code" href="structs_mcid.html#ab1ef95de31552207b5a74ee0c5f13112">pXdmad</a>         = pXdmad;
<a name="l00482"></a>00482     pMcid-&gt;<a class="code" href="structs_mcid.html#a420b0285bf591a6b63ab9083a824bb01">dwDmaCh</a>       = XDMAD_ALLOC_FAILED;
<a name="l00483"></a>00483     pMcid-&gt;<a class="code" href="structs_mcid.html#a0baab7684f25eb6450e43dead3b4d45f">dwXfrNdx</a>      = 0;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     pMcid-&gt;<a class="code" href="structs_mcid.html#aeaec6201b5c461e5759994fc3c1b1d9b">dwMck</a>     = dwMck;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     pMcid-&gt;<a class="code" href="structs_mcid.html#a546ddd9ff24beec7e92544b0f5e3eafe">bID</a>       = bID;
<a name="l00488"></a>00488     pMcid-&gt;<a class="code" href="structs_mcid.html#a064efb0868d3874ff175eb9eb9633449">bPolling</a>  = bPolling;
<a name="l00489"></a>00489     pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a>    = MCID_IDLE;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     _PeripheralEnable(bID);
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <a class="code" href="mcid__dma_8c.html#adbfb1c85cace4fdec2f80ff0d76ad3b6">MCI_RESET</a>(pMci);
<a name="l00494"></a>00494     <a class="code" href="mcid__dma_8c.html#aa3adb1fa6fdb984ac86b81ea8bf55937">MCI_DISABLE</a> (pMci);
<a name="l00495"></a>00495     <a class="code" href="group__hsmci__functions.html#ga273099b0076489b4216672fb85d8a813" title="Disable one or more interrupt sources of MCI peripheral.">HSMCI_DisableIt</a>(pMci, 0xFFFFFFFF);
<a name="l00496"></a>00496     <a class="code" href="group__hsmci__functions.html#ga6668e349edf32e148bfd5fcf45b1eccc" title="Configure the Data Timeout.">HSMCI_ConfigureDataTO</a>(pMci, HSMCI_DTOR_DTOCYC(0xFF)
<a name="l00497"></a>00497                            | <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga3a4a62a4033d95cc26faef1094a9f9a2" title="(HSMCI_DTOR) DTOCYC x 1048576">HSMCI_DTOR_DTOMUL_1048576</a>);
<a name="l00498"></a>00498     <a class="code" href="group__hsmci__functions.html#ga75c6f68a1b67b73c8b80482b5cc17c45" title="Configure the Completion Signal Timeout.">HSMCI_ConfigureCompletionTO</a>(pMci , HSMCI_CSTOR_CSTOCYC(0xFF)
<a name="l00499"></a>00499                                  | <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gad94bf4c35e56b397c8bcca19f1c35d35" title="(HSMCI_CSTOR) CSTOCYC x 1048576">HSMCI_CSTOR_CSTOMUL_1048576</a>);
<a name="l00500"></a>00500     <span class="comment">/* Set the Mode Register: 400KHz */</span>
<a name="l00501"></a>00501     clkDiv = (dwMck / (<a class="code" href="group__mcid__defines.html#gaabec4bd84457d946f08e884d7113d392">MCI_INITIAL_SPEED</a> &lt;&lt; 1)) - 1;
<a name="l00502"></a>00502     <a class="code" href="group__hsmci__functions.html#gaf51e5a4c668bd49302fbab8329215445" title="Configures a MCI peripheral as specified.">HSMCI_ConfigureMode</a>(pMci, (clkDiv | HSMCI_MR_PWSDIV(0x7)));
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     <a class="code" href="group__hsmci__functions.html#ga2c391b7420eb0660c30b87510a862770" title="Enable Multi-Media Interface.">HSMCI_Enable</a>(pMci);
<a name="l00505"></a>00505     <a class="code" href="group__hsmci__functions.html#gae212bc49645bc7b10e0f46159737f874" title="Configure the HSMCI.">HSMCI_Configure</a>(pMci, <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga1eaae769ff1bde3835d89e11b0e5945e" title="(HSMCI_CFG) HSMCI Internal FIFO control mode">HSMCI_CFG_FIFOMODE</a> | <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gaaa730d5df74270d50ae4880377ac5936" title="(HSMCI_CFG) Flow Error flag reset control mode">HSMCI_CFG_FERRCTRL</a>);
<a name="l00506"></a>00506     <span class="comment">/* Enable DMA */</span>
<a name="l00507"></a>00507     <a class="code" href="group__hsmci__functions.html#gaf2f9c4d2b276027b3c238530ed107308" title="Enable the HSMCI DMA.">HSMCI_EnableDma</a>(pMci, 1);
<a name="l00508"></a>00508     <span class="comment">//_PeripheralDisable(bID);</span>
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 <span class="comment"></span>
<a name="l00511"></a>00511 <span class="comment">/**</span>
<a name="l00512"></a>00512 <span class="comment"> * Lock the MCI driver for slot N access</span>
<a name="l00513"></a>00513 <span class="comment"> */</span>
<a name="l00514"></a><a class="code" href="group__mcid__functions.html#ga166b9dbbc64963a05679dc4a71ebe1b0">00514</a> uint32_t <a class="code" href="group__mcid__functions.html#ga166b9dbbc64963a05679dc4a71ebe1b0">MCID_Lock</a>(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid, uint8_t <a class="code" href="cciddriver_8h.html#ac45819be33e5342f51430d69f2d7d474">bSlot</a>)
<a name="l00515"></a>00515 {
<a name="l00516"></a>00516     <a class="code" href="struct_hsmci.html" title="Hsmci hardware registers.">Hsmci</a> *pHw = pMcid-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>;
<a name="l00517"></a>00517     uint32_t sdcr;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     assert(pMcid);
<a name="l00520"></a>00520     assert(pMcid-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>);
<a name="l00521"></a>00521 
<a name="l00522"></a>00522     <span class="keywordflow">if</span> (bSlot &gt; 0)
<a name="l00523"></a>00523         <span class="keywordflow">return</span> SDMMC_ERROR_PARAM;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     <span class="keywordflow">if</span> (pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> &gt;= <a class="code" href="group__mcid__defines.html#ga643375622359916ae33a046c39358ec2">MCID_LOCKED</a>)
<a name="l00526"></a>00526         <span class="keywordflow">return</span> SDMMC_ERROR_LOCKED;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528     pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> = MCID_LOCKED;
<a name="l00529"></a>00529     sdcr = pHw-&gt;<a class="code" href="struct_hsmci.html#ac694723e07a911c323c0023c63e11e56" title="(Hsmci Offset: 0x0C) SD/SDIO Card Register">HSMCI_SDCR</a> &amp; ~(uint32_t)<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga24aceed9db8a4e497733d3843337c72d" title="(HSMCI_SDCR) SDCard/SDIO Slot">HSMCI_SDCR_SDCSEL_Msk</a>;
<a name="l00530"></a>00530     pHw-&gt;<a class="code" href="struct_hsmci.html#ac694723e07a911c323c0023c63e11e56" title="(Hsmci Offset: 0x0C) SD/SDIO Card Register">HSMCI_SDCR</a> = sdcr | (bSlot &lt;&lt; HSMCI_SDCR_SDCSEL_Pos);
<a name="l00531"></a>00531     <span class="keywordflow">return</span> SDMMC_OK;
<a name="l00532"></a>00532 }
<a name="l00533"></a>00533 <span class="comment"></span>
<a name="l00534"></a>00534 <span class="comment">/**</span>
<a name="l00535"></a>00535 <span class="comment"> * Release the driver.</span>
<a name="l00536"></a>00536 <span class="comment"> */</span>
<a name="l00537"></a><a class="code" href="group__mcid__functions.html#ga9920930e7ebcc4f1eaacdb0156f3f752">00537</a> uint32_t <a class="code" href="group__mcid__functions.html#ga9920930e7ebcc4f1eaacdb0156f3f752">MCID_Release</a>(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid)
<a name="l00538"></a>00538 {
<a name="l00539"></a>00539     assert(pMcid);
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     <span class="keywordflow">if</span> (pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> &gt;= <a class="code" href="group__mcid__defines.html#gae74337ed26d19d98b730bbf3f11cc00c">MCID_CMD</a>)
<a name="l00542"></a>00542         <span class="keywordflow">return</span> SDMMC_ERROR_BUSY;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> = MCID_IDLE;
<a name="l00545"></a>00545     <span class="keywordflow">return</span> SDMMC_OK;
<a name="l00546"></a>00546 }
<a name="l00547"></a>00547 <span class="comment"></span>
<a name="l00548"></a>00548 <span class="comment">/**</span>
<a name="l00549"></a>00549 <span class="comment"> * SD/MMC command.</span>
<a name="l00550"></a>00550 <span class="comment"> */</span>
<a name="l00551"></a><a class="code" href="group__mcid__functions.html#ga71c682b80833894cc847b231139874d5">00551</a> uint32_t <a class="code" href="group__mcid__functions.html#ga71c682b80833894cc847b231139874d5">MCID_SendCmd</a>(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid, <span class="keywordtype">void</span> *pCommand)
<a name="l00552"></a>00552 {
<a name="l00553"></a>00553     <a class="code" href="struct_hsmci.html" title="Hsmci hardware registers.">Hsmci</a> *pHw = pMcid-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>;
<a name="l00554"></a>00554     <a class="code" href="structs_sdmmc_command.html">sSdmmcCommand</a> *pCmd = pCommand;
<a name="l00555"></a>00555     uint32_t mr, ier;
<a name="l00556"></a>00556     uint32_t cmdr;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     assert(pMcid);
<a name="l00559"></a>00559     assert(pMcid-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>);
<a name="l00560"></a>00560     assert(pCmd);
<a name="l00561"></a>00561 
<a name="l00562"></a>00562     <span class="comment">//printf(&quot;cmd = %d \n\r&quot;,pCmd-&gt;bCmd);</span>
<a name="l00563"></a>00563     <span class="keywordflow">if</span> (!<a class="code" href="group__mcid__functions.html#gae956aa6961d961be8d3791413d81497f">MCID_IsCmdCompleted</a>(pMcid))
<a name="l00564"></a>00564         <span class="keywordflow">return</span> SDMMC_ERROR_BUSY;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> = MCID_CMD;
<a name="l00567"></a>00567     pMcid-&gt;<a class="code" href="structs_mcid.html#a113e7e46d78a1cc63b5e47311198c0b5">pCmd</a>   = pCmd;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569     <span class="comment">//_PeripheralEnable(pMcid-&gt;bID);</span>
<a name="l00570"></a>00570     <a class="code" href="mcid__dma_8c.html#aa3adb1fa6fdb984ac86b81ea8bf55937">MCI_DISABLE</a>(pHw);
<a name="l00571"></a>00571     mr = <a class="code" href="group__hsmci__functions.html#ga016a1f6f3a075807c55a2ad2cf23255a" title="Return mode register.">HSMCI_GetMode</a>(pHw) &amp; (~(uint32_t)(<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gae82669f045fc9b26f3d2b326ce8ad03e" title="(HSMCI_MR) Write Proof Enable">HSMCI_MR_WRPROOF</a> |
<a name="l00572"></a>00572                                            <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga4f98fefbfbf58bff16877b103e785fd7" title="(HSMCI_MR) Read Proof Enable">HSMCI_MR_RDPROOF</a> | <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gaddc2a8927d0bfaa8563211f47e1065c7" title="(HSMCI_MR) Force Byte Transfer">HSMCI_MR_FBYTE</a>));
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <span class="comment">/* Special: PowerON Init */</span>
<a name="l00575"></a>00575     <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.wVal == <a class="code" href="group__sdmmc__cmd__op.html#gae0ad41a789fdec67920c50eb77c775a5">SDMMC_CMD_POWERONINIT</a>) {
<a name="l00576"></a>00576         <a class="code" href="group__hsmci__functions.html#gaf51e5a4c668bd49302fbab8329215445" title="Configures a MCI peripheral as specified.">HSMCI_ConfigureMode</a>(pHw, mr);
<a name="l00577"></a>00577         ier = HSMCI_IER_XFRDONE;
<a name="l00578"></a>00578     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#a125fe68e48edd013227081fc0af0c36b">xfrData</a> == <a class="code" href="group__sdmmc__cmd__op.html#ga10d437fda0b41242a6673d2a6b88ad14">SDMMC_CMD_STOPXFR</a>) {
<a name="l00579"></a>00579         <span class="comment">/* Normal command: idle the bus */</span>
<a name="l00580"></a>00580         <a class="code" href="group__hsmci__functions.html#gaf51e5a4c668bd49302fbab8329215445" title="Configures a MCI peripheral as specified.">HSMCI_ConfigureMode</a>(pHw, mr);
<a name="l00581"></a>00581         ier = <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gac1650a6567fc846c80a2c432054a200d" title="(HSMCI_IER) Transfer Done Interrupt enable">HSMCI_IER_XFRDONE</a> | STATUS_ERRORS_RESP;
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583     <span class="comment">/* No data transfer */</span>
<a name="l00584"></a>00584     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.wVal &amp; <a class="code" href="group__sdmmc__cmd__op.html#ga9dc3e7478841b0b6e96d752288195a72">SDMMC_CMD_CNODATA</a>(0xF)) == <a class="code" href="group__sdmmc__cmd__op.html#ga9dc3e7478841b0b6e96d752288195a72">SDMMC_CMD_CNODATA</a>(0)) {
<a name="l00585"></a>00585         ier = <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gac1650a6567fc846c80a2c432054a200d" title="(HSMCI_IER) Transfer Done Interrupt enable">HSMCI_IER_XFRDONE</a> | STATUS_ERRORS_RESP;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587         <span class="comment">/* R3 response, no CRC */</span>
<a name="l00588"></a>00588         <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#a029a404cb2d8bd5ac27adbe7d051fa76">respType</a> == 3)
<a name="l00589"></a>00589             ier &amp;= ~(uint32_t)<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gabe7c3e312a35aee5d7aba00bb619fba1" title="(HSMCI_IER) Response CRC Error Interrupt Enable">HSMCI_IER_RCRCE</a>;
<a name="l00590"></a>00590     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a> == 0 || pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#af4475ca3a7a1fbd120f8e1635c07fdcd">pData</a> == 0) {
<a name="l00591"></a>00591         <span class="comment">/* Data command but no following */</span>
<a name="l00592"></a>00592         <a class="code" href="group__hsmci__functions.html#gaf51e5a4c668bd49302fbab8329215445" title="Configures a MCI peripheral as specified.">HSMCI_ConfigureMode</a>(pHw, mr | <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gae82669f045fc9b26f3d2b326ce8ad03e" title="(HSMCI_MR) Write Proof Enable">HSMCI_MR_WRPROOF</a>
<a name="l00593"></a>00593                             | <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga4f98fefbfbf58bff16877b103e785fd7" title="(HSMCI_MR) Read Proof Enable">HSMCI_MR_RDPROOF</a>);
<a name="l00594"></a>00594         <a class="code" href="group__hsmci__functions.html#gab17151fd3e0b1a81b78067b7f07b0424" title="Set block len &amp;amp; count for transfer.">HSMCI_ConfigureTransfer</a>(pHw, pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a>, pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a>);
<a name="l00595"></a>00595         ier = <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga858b785da3e669c8ecb8f85dcf9016bd" title="(HSMCI_IER) Command Ready Interrupt Enable">HSMCI_IER_CMDRDY</a> | STATUS_ERRORS_RESP;
<a name="l00596"></a>00596     } <span class="keywordflow">else</span> {
<a name="l00597"></a>00597         <span class="comment">/* Command with data */</span>
<a name="l00598"></a>00598         <span class="comment">/* Setup block size */</span>
<a name="l00599"></a>00599         <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#a109e814d01e91583317597260aed13f9">sendCmd</a>)
<a name="l00600"></a>00600             <a class="code" href="group__hsmci__functions.html#gab17151fd3e0b1a81b78067b7f07b0424" title="Set block len &amp;amp; count for transfer.">HSMCI_ConfigureTransfer</a>(pHw, pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a>, pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a>);
<a name="l00601"></a>00601 
<a name="l00602"></a>00602         <span class="comment">/* Block size is 0, force byte */</span>
<a name="l00603"></a>00603         <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a> == 0)
<a name="l00604"></a>00604             pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a> = 1;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606         <span class="comment">/* Force byte transfer */</span>
<a name="l00607"></a>00607         <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a> &amp; 0x3)
<a name="l00608"></a>00608             mr |= HSMCI_MR_FBYTE;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         <span class="comment">/* Set block size &amp; MR */</span>
<a name="l00611"></a>00611         <a class="code" href="group__hsmci__functions.html#gaf51e5a4c668bd49302fbab8329215445" title="Configures a MCI peripheral as specified.">HSMCI_ConfigureMode</a>(pHw, mr | <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gae82669f045fc9b26f3d2b326ce8ad03e" title="(HSMCI_MR) Write Proof Enable">HSMCI_MR_WRPROOF</a>
<a name="l00612"></a>00612                             | <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga4f98fefbfbf58bff16877b103e785fd7" title="(HSMCI_MR) Read Proof Enable">HSMCI_MR_RDPROOF</a>);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         <span class="comment">/* DMA write */</span>
<a name="l00615"></a>00615         <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#a125fe68e48edd013227081fc0af0c36b">xfrData</a> == <a class="code" href="group__sdmmc__cmd__op.html#gaff21ce7f6ff0c4dce6742f404945b55b">SDMMC_CMD_TX</a>) {
<a name="l00616"></a>00616             <span class="keywordflow">if</span> (_MciDMAPrepare(pMcid, 0)) {
<a name="l00617"></a>00617                 _FinishCmd(pMcid, <a class="code" href="group__sdmmc__rc.html#gaaea1bf5ab746268b578c341c2de5dbe1">SDMMC_ERROR_BUSY</a>);
<a name="l00618"></a>00618                 <span class="keywordflow">return</span> SDMMC_ERROR_BUSY;
<a name="l00619"></a>00619             }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621             _MciDMA(pMcid, (mr &amp; <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gaddc2a8927d0bfaa8563211f47e1065c7" title="(HSMCI_MR) Force Byte Transfer">HSMCI_MR_FBYTE</a>), 0);
<a name="l00622"></a>00622             ier = <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gac1650a6567fc846c80a2c432054a200d" title="(HSMCI_IER) Transfer Done Interrupt enable">HSMCI_IER_XFRDONE</a> | STATUS_ERRORS_DATA;
<a name="l00623"></a>00623 
<a name="l00624"></a>00624             <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a> &gt; 1) ier |= HSMCI_IER_FIFOEMPTY;
<a name="l00625"></a>00625         } <span class="keywordflow">else</span> {
<a name="l00626"></a>00626             <span class="keywordflow">if</span> (_MciDMAPrepare(pMcid, 1)) {
<a name="l00627"></a>00627                 _FinishCmd(pMcid, <a class="code" href="group__sdmmc__rc.html#gaaea1bf5ab746268b578c341c2de5dbe1">SDMMC_ERROR_BUSY</a>);
<a name="l00628"></a>00628                 <span class="keywordflow">return</span> SDMMC_ERROR_BUSY;
<a name="l00629"></a>00629             }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631             _MciDMA(pMcid, (mr &amp; <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gaddc2a8927d0bfaa8563211f47e1065c7" title="(HSMCI_MR) Force Byte Transfer">HSMCI_MR_FBYTE</a>), 1);
<a name="l00632"></a>00632             ier = <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gac1650a6567fc846c80a2c432054a200d" title="(HSMCI_IER) Transfer Done Interrupt enable">HSMCI_IER_XFRDONE</a> | STATUS_ERRORS_DATA;
<a name="l00633"></a>00633 
<a name="l00634"></a>00634             <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a> &gt; 1) ier |= HSMCI_IER_FIFOEMPTY;
<a name="l00635"></a>00635         }
<a name="l00636"></a>00636     }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638     <a class="code" href="mcid__dma_8c.html#aaf10b2ffdc8da0b47ef6ae3401f4a1b5">MCI_ENABLE</a>(pHw);
<a name="l00639"></a>00639 
<a name="l00640"></a>00640     <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.wVal &amp; (<a class="code" href="group__sdmmc__cmd__op.html#ga2c48a574fcc8e1b6a312e06e7b93a2b7">SDMMC_CMD_bmPOWERON</a> | <a class="code" href="group__sdmmc__cmd__op.html#gadfa232fa7f7efdcac6725f1087d0ac2d">SDMMC_CMD_bmCOMMAND</a>)) {
<a name="l00641"></a>00641         cmdr = pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#abe82de8dcc507f3f8de777ea6a2f392f">bCmd</a>;
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#a119e39369915f1cc5676b960faad2bd0">powerON</a>)
<a name="l00644"></a>00644             cmdr |= (<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gafb12aefab4ad39b1e43cf7c8c22571e4" title="(HSMCI_CMDR) Open Drain Command">HSMCI_CMDR_OPDCMD</a> | HSMCI_CMDR_SPCMD_INIT);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646         <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#a7ea5b02e5150352bdcc45f36b3d74e39">odON</a>)
<a name="l00647"></a>00647             cmdr |= HSMCI_CMDR_OPDCMD;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649         <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#a109e814d01e91583317597260aed13f9">sendCmd</a>)
<a name="l00650"></a>00650             cmdr |= HSMCI_CMDR_MAXLAT;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652         <span class="keywordflow">switch</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#a125fe68e48edd013227081fc0af0c36b">xfrData</a>) {
<a name="l00653"></a>00653         <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__cmd__op.html#gaff21ce7f6ff0c4dce6742f404945b55b">SDMMC_CMD_TX</a>:
<a name="l00654"></a>00654             <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#ad9848be996cd5acec3968db46975f93c">ioCmd</a>) {
<a name="l00655"></a>00655                 cmdr |= (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a> == 1) ?
<a name="l00656"></a>00656                         <a class="code" href="mcid__dma_8c.html#a2ac6ad1d89b6beb197d04ca19f42975b">_CMDR_SDIO_BYTE</a> :
<a name="l00657"></a>00657                         <a class="code" href="mcid__dma_8c.html#ad953989c7cced1d47aa0f3794544387d">_CMDR_SDIO_BLOCK</a>;
<a name="l00658"></a>00658             } <span class="keywordflow">else</span> {
<a name="l00659"></a>00659                 cmdr |= (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a> == 1) ?
<a name="l00660"></a>00660                         <a class="code" href="mcid__dma_8c.html#a89ac994f84d8e9b8a91a6174ab676cef">_CMDR_SDMEM_SINGLE</a> :
<a name="l00661"></a>00661                         <a class="code" href="mcid__dma_8c.html#a5768076a8ba20db64599e81d5a5c8c11">_CMDR_SDMEM_MULTI</a>;
<a name="l00662"></a>00662             }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664             <span class="keywordflow">break</span>;
<a name="l00665"></a>00665 
<a name="l00666"></a>00666         <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__cmd__op.html#gad40090404242cdaf14e69e460d71d949">SDMMC_CMD_RX</a>:
<a name="l00667"></a>00667             <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#ad9848be996cd5acec3968db46975f93c">ioCmd</a>) {
<a name="l00668"></a>00668                 cmdr |= <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga1f54942091853a89b4010e5719c914f6" title="(HSMCI_CMDR) Read.">HSMCI_CMDR_TRDIR_READ</a>
<a name="l00669"></a>00669                         | ((pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a3b6d8109ea72b72cb1ebf7427fe7b310">wBlockSize</a> == 1) ?
<a name="l00670"></a>00670                            <a class="code" href="mcid__dma_8c.html#a2ac6ad1d89b6beb197d04ca19f42975b">_CMDR_SDIO_BYTE</a> :
<a name="l00671"></a>00671                            <a class="code" href="mcid__dma_8c.html#ad953989c7cced1d47aa0f3794544387d">_CMDR_SDIO_BLOCK</a>);
<a name="l00672"></a>00672             } <span class="keywordflow">else</span> {
<a name="l00673"></a>00673                 cmdr |= <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga1f54942091853a89b4010e5719c914f6" title="(HSMCI_CMDR) Read.">HSMCI_CMDR_TRDIR_READ</a>
<a name="l00674"></a>00674                         | ((pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac951c65d73d9e052a05cb353c4004721">wNbBlocks</a> == 1) ?
<a name="l00675"></a>00675                            <a class="code" href="mcid__dma_8c.html#a89ac994f84d8e9b8a91a6174ab676cef">_CMDR_SDMEM_SINGLE</a> :
<a name="l00676"></a>00676                            <a class="code" href="mcid__dma_8c.html#a5768076a8ba20db64599e81d5a5c8c11">_CMDR_SDMEM_MULTI</a>);
<a name="l00677"></a>00677             }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679             <span class="keywordflow">break</span>;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681         <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__cmd__op.html#ga10d437fda0b41242a6673d2a6b88ad14">SDMMC_CMD_STOPXFR</a>:
<a name="l00682"></a>00682             cmdr |= HSMCI_CMDR_TRCMD_STOP_DATA;
<a name="l00683"></a>00683             <span class="keywordflow">break</span>;
<a name="l00684"></a>00684         }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         <span class="keywordflow">switch</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#a029a404cb2d8bd5ac27adbe7d051fa76">respType</a>) {
<a name="l00687"></a>00687         <span class="keywordflow">case</span> 3: <span class="keywordflow">case</span> 4:
<a name="l00688"></a>00688             <span class="comment">/* ignore CRC error */</span>
<a name="l00689"></a>00689             ier &amp;= ~(uint32_t)<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gabe7c3e312a35aee5d7aba00bb619fba1" title="(HSMCI_IER) Response CRC Error Interrupt Enable">HSMCI_IER_RCRCE</a>;
<a name="l00690"></a>00690 
<a name="l00691"></a>00691         <span class="keywordflow">case</span> 1: <span class="keywordflow">case</span> 5: <span class="keywordflow">case</span> 6: <span class="keywordflow">case</span> 7:
<a name="l00692"></a>00692             cmdr |= HSMCI_CMDR_RSPTYP_48_BIT;
<a name="l00693"></a>00693             <span class="keywordflow">break</span>;
<a name="l00694"></a>00694 
<a name="l00695"></a>00695         <span class="keywordflow">case</span> 2:
<a name="l00696"></a>00696             cmdr |= HSMCI_CMDR_RSPTYP_136_BIT;
<a name="l00697"></a>00697             <span class="keywordflow">break</span>;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699         <span class="comment">/* No response, ignore RTOE */</span>
<a name="l00700"></a>00700         <span class="keywordflow">default</span>:
<a name="l00701"></a>00701             ier &amp;= ~(uint32_t)<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga79f508d7d3f153c04a23d82d3411a303" title="(HSMCI_IER) Response Time-out Error Interrupt Enable">HSMCI_IER_RTOE</a>;
<a name="l00702"></a>00702         }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704         pHw-&gt;<a class="code" href="struct_hsmci.html#a9b15bcf2ba54512c6d0ea6e84dfe9afb" title="(Hsmci Offset: 0x10) Argument Register">HSMCI_ARGR</a> = pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#ac70faeb8d807f25e7db8933b18314d13">dwArg</a>;
<a name="l00705"></a>00705         pHw-&gt;<a class="code" href="struct_hsmci.html#a249680f0d1434ba963ae4c339c878856" title="(Hsmci Offset: 0x14) Command Register">HSMCI_CMDR</a> = cmdr;
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <span class="comment">/* Ignore CRC error for R3 &amp; R4 */</span>
<a name="l00709"></a>00709     <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#a125fe68e48edd013227081fc0af0c36b">xfrData</a> == <a class="code" href="group__sdmmc__cmd__op.html#ga10d437fda0b41242a6673d2a6b88ad14">SDMMC_CMD_STOPXFR</a>)
<a name="l00710"></a>00710         ier &amp;= ~STATUS_ERRORS_DATA;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <span class="comment">/* Enable status flags */</span>
<a name="l00713"></a>00713     <a class="code" href="group__hsmci__functions.html#ga9b3811aee4fc3cef7fcc8b38ab0fa7f2" title="Enables one or more interrupt sources of MCI peripheral.">HSMCI_EnableIt</a>(pHw, ier);
<a name="l00714"></a>00714     <span class="keywordflow">return</span> SDMMC_OK;
<a name="l00715"></a>00715 }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717 <span class="keyword">static</span> uint32_t dwMsk;<span class="comment"></span>
<a name="l00718"></a>00718 <span class="comment">/**</span>
<a name="l00719"></a>00719 <span class="comment"> * Process pending events on the given MCI driver.</span>
<a name="l00720"></a>00720 <span class="comment"> */</span>
<a name="l00721"></a><a class="code" href="group__mcid__functions.html#ga8b24d6b7cbfd7240dc23dbd4c6759975">00721</a> <span class="keywordtype">void</span> <a class="code" href="group__mcid__functions.html#ga8b24d6b7cbfd7240dc23dbd4c6759975">MCID_Handler</a>(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid)
<a name="l00722"></a>00722 {
<a name="l00723"></a>00723     <a class="code" href="struct_hsmci.html" title="Hsmci hardware registers.">Hsmci</a> *pHw = pMcid-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>;
<a name="l00724"></a>00724     <a class="code" href="structs_sdmmc_command.html">sSdmmcCommand</a> *pCmd = pMcid-&gt;<a class="code" href="structs_mcid.html#a113e7e46d78a1cc63b5e47311198c0b5">pCmd</a>;
<a name="l00725"></a>00725     <span class="comment">//uint32_t dwSr, dwMsk, dwMaskedSr;</span>
<a name="l00726"></a>00726     uint32_t dwSr, dwMaskedSr;
<a name="l00727"></a>00727     assert(pMcid);
<a name="l00728"></a>00728     assert(pMcid-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="comment">/* Do nothing if no pending command */</span>
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (pCmd == NULL) {
<a name="l00732"></a>00732         <span class="keywordflow">if</span> (pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> &gt;= <a class="code" href="group__mcid__defines.html#gae74337ed26d19d98b730bbf3f11cc00c">MCID_CMD</a>)
<a name="l00733"></a>00733             pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> = MCID_LOCKED;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735         <span class="keywordflow">return</span>;
<a name="l00736"></a>00736     }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     <span class="comment">/* Read status */</span>
<a name="l00739"></a>00739     dwSr  = <a class="code" href="group__hsmci__functions.html#ga7395ec7b356ef056f786107518137a56" title="Return the status register.">HSMCI_GetStatus</a>(pHw);
<a name="l00740"></a>00740     dwMsk = <a class="code" href="group__hsmci__functions.html#gae4fc955f147a6f1fa8d8c511e7f9f4f6" title="Return the interrupt mask register.">HSMCI_GetItMask</a>(pHw);
<a name="l00741"></a>00741     dwMaskedSr = dwSr &amp; dwMsk;
<a name="l00742"></a>00742 
<a name="l00743"></a>00743     <span class="comment">/* Check errors */</span>
<a name="l00744"></a>00744     <span class="keywordflow">if</span> (dwMaskedSr &amp; <a class="code" href="mcid__dma_8c.html#ab1a8025fbf9b28aee8d6e079b51e86d9">STATUS_ERRORS</a>) {
<a name="l00745"></a>00745         <span class="keywordflow">if</span> (dwMaskedSr &amp; <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga4f429a2f616db90c3d7c41459ab56e73" title="(HSMCI_SR) Response Time-out Error (cleared by writing in HSMCI_CMDR)">HSMCI_SR_RTOE</a>)
<a name="l00746"></a>00746             pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#aaf9241225f75ddfad39d1652695e7d6f">bStatus</a> = SDMMC_ERROR_NORESPONSE;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748         <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#abe82de8dcc507f3f8de777ea6a2f392f">bCmd</a> != 12) pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> = MCID_ERROR;
<a name="l00749"></a>00749 
<a name="l00750"></a>00750         <span class="comment">//pMcid-&gt;bState = MCID_ERROR;</span>
<a name="l00751"></a>00751     }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     dwMsk &amp;= ~STATUS_ERRORS;
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     <span class="comment">/* Check command complete */</span>
<a name="l00756"></a>00756     <span class="keywordflow">if</span> (dwMaskedSr &amp; <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga591db73fa4eeef61c0d346d1434e41b3" title="(HSMCI_SR) Command Ready (cleared by writing in HSMCI_CMDR)">HSMCI_SR_CMDRDY</a>) {
<a name="l00757"></a>00757         <a class="code" href="trace_8h.html#a67a8f9bc74358aa21745a76e23768dae">TRACE_DEBUG</a>(<span class="stringliteral">&quot;HSMCI_SR_CMDRDY \n\r&quot;</span>);
<a name="l00758"></a>00758         <a class="code" href="group__hsmci__functions.html#ga273099b0076489b4216672fb85d8a813" title="Disable one or more interrupt sources of MCI peripheral.">HSMCI_DisableIt</a>(pHw, <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gaf0a3f9cded1fca517c5bfedade4c0739" title="(HSMCI_IDR) Command Ready Interrupt Disable">HSMCI_IDR_CMDRDY</a>);
<a name="l00759"></a>00759         dwMsk &amp;= ~(uint32_t)<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga831c57fd6b95b2012f8c3e0fd01bdb76" title="(HSMCI_IMR) Command Ready Interrupt Mask">HSMCI_IMR_CMDRDY</a>;
<a name="l00760"></a>00760     }
<a name="l00761"></a>00761 
<a name="l00762"></a>00762     <span class="comment">/* Check if not busy */</span>
<a name="l00763"></a>00763     <span class="keywordflow">if</span> (dwMaskedSr &amp; <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gae0e46f9c74375e9c47b026eeda8f24fd" title="(HSMCI_SR) HSMCI Not Busy">HSMCI_SR_NOTBUSY</a>) {
<a name="l00764"></a>00764         <a class="code" href="trace_8h.html#a67a8f9bc74358aa21745a76e23768dae">TRACE_DEBUG</a>(<span class="stringliteral">&quot;NOTBUSY &quot;</span>);
<a name="l00765"></a>00765         <a class="code" href="group__hsmci__functions.html#ga273099b0076489b4216672fb85d8a813" title="Disable one or more interrupt sources of MCI peripheral.">HSMCI_DisableIt</a>(pHw, <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gac5b4a805d81e1e3e9e256ab925c44c17" title="(HSMCI_IDR) Data Not Busy Interrupt Disable">HSMCI_IDR_NOTBUSY</a>);
<a name="l00766"></a>00766         dwMsk &amp;= ~(uint32_t)<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga852b1fe28fbb1698a5552e8ae3f791d4" title="(HSMCI_IMR) Data Not Busy Interrupt Mask">HSMCI_IMR_NOTBUSY</a>;
<a name="l00767"></a>00767     }
<a name="l00768"></a>00768 
<a name="l00769"></a>00769     <span class="comment">/* Check if TX ready */</span>
<a name="l00770"></a>00770     <span class="keywordflow">if</span> (dwMaskedSr &amp; <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga07b78e83820a30eed7885fa14905f63f" title="(HSMCI_SR) Transmit Ready (cleared by writing in HSMCI_TDR)">HSMCI_SR_TXRDY</a>) {
<a name="l00771"></a>00771         <a class="code" href="trace_8h.html#a67a8f9bc74358aa21745a76e23768dae">TRACE_DEBUG</a>(<span class="stringliteral">&quot;TXRDY &quot;</span>);
<a name="l00772"></a>00772         dwMsk &amp;= ~(uint32_t)<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gaed70441a914b325f4be0b0196b2c04ed" title="(HSMCI_IMR) Transmit Ready Interrupt Mask">HSMCI_IMR_TXRDY</a>;
<a name="l00773"></a>00773     }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775     <span class="comment">/* Check if FIFO empty (all data sent) */</span>
<a name="l00776"></a>00776     <span class="keywordflow">if</span> (dwMaskedSr &amp; <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga9846f5f83409d76b6b8502cf94589187" title="(HSMCI_SR) FIFO empty flag">HSMCI_SR_FIFOEMPTY</a>) {
<a name="l00777"></a>00777         <span class="comment">/* Disable FIFO empty */</span>
<a name="l00778"></a>00778         <a class="code" href="group__hsmci__functions.html#ga273099b0076489b4216672fb85d8a813" title="Disable one or more interrupt sources of MCI peripheral.">HSMCI_DisableIt</a>(pHw, <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga067256d7899f43245dfe745f70f3f1bc" title="(HSMCI_IDR) FIFO empty Interrupt Disable">HSMCI_IDR_FIFOEMPTY</a>);
<a name="l00779"></a>00779         dwMsk &amp;= ~(uint32_t)<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga33b7199f2e3ca940fa5054e6ef943a0c" title="(HSMCI_IMR) FIFO Empty Interrupt Mask">HSMCI_IMR_FIFOEMPTY</a>;
<a name="l00780"></a>00780         <a class="code" href="trace_8h.html#a67a8f9bc74358aa21745a76e23768dae">TRACE_DEBUG</a>(<span class="stringliteral">&quot;FIFOEMPTY %x \n\r&quot;</span>, dwMsk);
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782 
<a name="l00783"></a>00783     <span class="comment">/* Check if DMA finished */</span>
<a name="l00784"></a>00784     <span class="keywordflow">if</span> (dwMaskedSr &amp; <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga520d6c71cc8234d21cfd0a826da0f467" title="(HSMCI_SR) Transfer Done flag">HSMCI_SR_XFRDONE</a>) {
<a name="l00785"></a>00785         <a class="code" href="group__hsmci__functions.html#ga273099b0076489b4216672fb85d8a813" title="Disable one or more interrupt sources of MCI peripheral.">HSMCI_DisableIt</a>(pHw, <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gabdbc566e7b410c527b4c68b966e51a3a" title="(HSMCI_IDR) Transfer Done Interrupt Disable">HSMCI_IDR_XFRDONE</a>);
<a name="l00786"></a>00786         dwMsk &amp;= ~(uint32_t)<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga933a2a3645c16dbb54c820e06589a6be" title="(HSMCI_IMR) Transfer Done Interrupt Mask">HSMCI_IMR_XFRDONE</a>;
<a name="l00787"></a>00787         <a class="code" href="trace_8h.html#a67a8f9bc74358aa21745a76e23768dae">TRACE_DEBUG</a>(<span class="stringliteral">&quot;HSMCI_SR_XFRDONE %x \n\r&quot;</span>, dwMsk);
<a name="l00788"></a>00788     }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     <span class="comment">/* All none error mask done, complete the command */</span>
<a name="l00791"></a>00791     <span class="keywordflow">if</span> (0 == dwMsk || pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> == <a class="code" href="group__mcid__defines.html#gaa30e68b8ca269164716661df052bd928">MCID_ERROR</a>) {
<a name="l00792"></a>00792         <span class="comment">/* Error reset */</span>
<a name="l00793"></a>00793         <span class="keywordflow">if</span> (pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> == <a class="code" href="group__mcid__defines.html#gaa30e68b8ca269164716661df052bd928">MCID_ERROR</a>)
<a name="l00794"></a>00794             MCI_Reset(pMcid, 1);
<a name="l00795"></a>00795         <span class="keywordflow">else</span>  {
<a name="l00796"></a>00796             pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#aaf9241225f75ddfad39d1652695e7d6f">bStatus</a> = SDMMC_SUCCESS;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798             <span class="keywordflow">if</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#acd20aeaf8c2944b499b7952304d3b84c">pResp</a>) {
<a name="l00799"></a>00799                 uint8_t bRspSize, i;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801                 <span class="keywordflow">switch</span> (pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#a1684611f768c0b81c1194155e50b5f09">cmdOp</a>.bmBits.<a class="code" href="structu_sdmmc_cmd_op_1_1___sdmmc_op_bm.html#a029a404cb2d8bd5ac27adbe7d051fa76">respType</a>) {
<a name="l00802"></a>00802                 <span class="keywordflow">case</span> 1: <span class="keywordflow">case</span> 3: <span class="keywordflow">case</span> 4: <span class="keywordflow">case</span> 5: <span class="keywordflow">case</span> 6: <span class="keywordflow">case</span> 7:
<a name="l00803"></a>00803                     bRspSize = 1;
<a name="l00804"></a>00804                     <span class="keywordflow">break</span>;
<a name="l00805"></a>00805 
<a name="l00806"></a>00806                 <span class="keywordflow">case</span> 2:
<a name="l00807"></a>00807                     bRspSize = 4;
<a name="l00808"></a>00808                     <span class="keywordflow">break</span>;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810                 <span class="keywordflow">default</span>:
<a name="l00811"></a>00811                     bRspSize = 0;
<a name="l00812"></a>00812                 }
<a name="l00813"></a>00813 
<a name="l00814"></a>00814                 <span class="keywordflow">for</span> (i = 0; i &lt; bRspSize; i ++)
<a name="l00815"></a>00815                     pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#acd20aeaf8c2944b499b7952304d3b84c">pResp</a>[i] = <a class="code" href="group__hsmci__functions.html#gafb6f3467813115f494f67c125f821264" title="Return the response register.">HSMCI_GetResponse</a>(pHw);
<a name="l00816"></a>00816             }
<a name="l00817"></a>00817         }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819         <span class="comment">/* Disable interrupts */</span>
<a name="l00820"></a>00820         <a class="code" href="group__hsmci__functions.html#ga273099b0076489b4216672fb85d8a813" title="Disable one or more interrupt sources of MCI peripheral.">HSMCI_DisableIt</a>(pHw, <a class="code" href="group__hsmci__functions.html#gae4fc955f147a6f1fa8d8c511e7f9f4f6" title="Return the interrupt mask register.">HSMCI_GetItMask</a>(pHw));
<a name="l00821"></a>00821         <span class="comment">/* Disable peripheral */</span>
<a name="l00822"></a>00822         <span class="comment">//_PeripheralDisable(pMcid-&gt;bID);</span>
<a name="l00823"></a>00823         <span class="comment">/* Command is finished */</span>
<a name="l00824"></a>00824         _FinishCmd(pMcid, pCmd-&gt;<a class="code" href="structs_sdmmc_command.html#aaf9241225f75ddfad39d1652695e7d6f">bStatus</a>);
<a name="l00825"></a>00825     }
<a name="l00826"></a>00826 }
<a name="l00827"></a>00827 <span class="comment"></span>
<a name="l00828"></a>00828 <span class="comment">/**</span>
<a name="l00829"></a>00829 <span class="comment"> * Cancel pending SD/MMC command.</span>
<a name="l00830"></a>00830 <span class="comment"> */</span>
<a name="l00831"></a><a class="code" href="group__mcid__functions.html#gaa42ae91258675d685937a68c69b2afdf">00831</a> uint32_t <a class="code" href="group__mcid__functions.html#gaa42ae91258675d685937a68c69b2afdf">MCID_CancelCmd</a>(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833     <span class="keywordflow">if</span> (pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> == <a class="code" href="group__mcid__defines.html#ga29c7e68de2be32285e3d013042cc3115">MCID_IDLE</a>)
<a name="l00834"></a>00834         <span class="keywordflow">return</span> SDMMC_ERROR_STATE;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     <span class="keywordflow">if</span> (pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> == <a class="code" href="group__mcid__defines.html#gae74337ed26d19d98b730bbf3f11cc00c">MCID_CMD</a>) {
<a name="l00837"></a>00837         <span class="comment">/* Cancel ... */</span>
<a name="l00838"></a>00838         MCI_Reset(pMcid, 1);
<a name="l00839"></a>00839         <span class="comment">/* Command is finished */</span>
<a name="l00840"></a>00840         _FinishCmd(pMcid, <a class="code" href="group__sdmmc__rc.html#ga8dcd19d19378b726efbc924aaff93920">SDMMC_ERROR_USER_CANCEL</a>);
<a name="l00841"></a>00841     }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843     <span class="keywordflow">return</span> SDMMC_OK;
<a name="l00844"></a>00844 }
<a name="l00845"></a>00845 <span class="comment"></span>
<a name="l00846"></a>00846 <span class="comment">/**</span>
<a name="l00847"></a>00847 <span class="comment"> * Reset MCID and disable HW</span>
<a name="l00848"></a>00848 <span class="comment"> */</span>
<a name="l00849"></a><a class="code" href="group__mcid__functions.html#ga03c7b7af1b4abf00f759b0a47c476baf">00849</a> <span class="keywordtype">void</span> <a class="code" href="group__mcid__functions.html#ga03c7b7af1b4abf00f759b0a47c476baf">MCID_Reset</a>(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid)
<a name="l00850"></a>00850 {
<a name="l00851"></a>00851     <a class="code" href="struct_hsmci.html" title="Hsmci hardware registers.">Hsmci</a> *pHw = pMcid-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>;
<a name="l00852"></a>00852 
<a name="l00853"></a>00853     <a class="code" href="group__mcid__functions.html#gaa42ae91258675d685937a68c69b2afdf">MCID_CancelCmd</a>(pMcid);
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     <span class="comment">//_PeripheralEnable(pMcid-&gt;bID);</span>
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     <span class="comment">/* Disable */</span>
<a name="l00858"></a>00858     <a class="code" href="mcid__dma_8c.html#aa3adb1fa6fdb984ac86b81ea8bf55937">MCI_DISABLE</a>(pHw);
<a name="l00859"></a>00859     <span class="comment">/* MR reset */</span>
<a name="l00860"></a>00860     <a class="code" href="group__hsmci__functions.html#gaf51e5a4c668bd49302fbab8329215445" title="Configures a MCI peripheral as specified.">HSMCI_ConfigureMode</a>(pHw, <a class="code" href="group__hsmci__functions.html#ga016a1f6f3a075807c55a2ad2cf23255a" title="Return mode register.">HSMCI_GetMode</a>(pHw) &amp; (<a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#gae8369103090e820bc7f9247d2e7b4a0c" title="(HSMCI_MR) Clock Divider">HSMCI_MR_CLKDIV_Msk</a>
<a name="l00861"></a>00861                         | <a class="code" href="group___s_a_m_e70___h_s_m_c_i.html#ga0f72be22ef0cb4549baba9cc0ca77b85" title="(HSMCI_MR) Power Saving Divider">HSMCI_MR_PWSDIV_Msk</a>));
<a name="l00862"></a>00862     <span class="comment">/* BLKR reset */</span>
<a name="l00863"></a>00863     <a class="code" href="group__hsmci__functions.html#gab17151fd3e0b1a81b78067b7f07b0424" title="Set block len &amp;amp; count for transfer.">HSMCI_ConfigureTransfer</a>(pHw, 0, 0);
<a name="l00864"></a>00864 
<a name="l00865"></a>00865     <span class="comment">/* Cancel ... */</span>
<a name="l00866"></a>00866     MCI_Reset(pMcid, 1);
<a name="l00867"></a>00867     <span class="comment">//_PeripheralDisable(pMcid-&gt;bID);</span>
<a name="l00868"></a>00868 
<a name="l00869"></a>00869     <span class="keywordflow">if</span> (pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> == <a class="code" href="group__mcid__defines.html#gae74337ed26d19d98b730bbf3f11cc00c">MCID_CMD</a>) {
<a name="l00870"></a>00870         <span class="comment">/* Command is finished */</span>
<a name="l00871"></a>00871         _FinishCmd(pMcid, <a class="code" href="group__sdmmc__rc.html#ga8dcd19d19378b726efbc924aaff93920">SDMMC_ERROR_USER_CANCEL</a>);
<a name="l00872"></a>00872     }
<a name="l00873"></a>00873 }
<a name="l00874"></a>00874 <span class="comment"></span>
<a name="l00875"></a>00875 <span class="comment">/**</span>
<a name="l00876"></a>00876 <span class="comment"> * Check if the command is finished</span>
<a name="l00877"></a>00877 <span class="comment"> */</span>
<a name="l00878"></a><a class="code" href="group__mcid__functions.html#gae956aa6961d961be8d3791413d81497f">00878</a> uint32_t <a class="code" href="group__mcid__functions.html#gae956aa6961d961be8d3791413d81497f">MCID_IsCmdCompleted</a>(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid)
<a name="l00879"></a>00879 {
<a name="l00880"></a>00880     <a class="code" href="structs_sdmmc_command.html">sSdmmcCommand</a> *pCmd = pMcid-&gt;<a class="code" href="structs_mcid.html#a113e7e46d78a1cc63b5e47311198c0b5">pCmd</a>;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882     <span class="keywordflow">if</span> (pMcid-&gt;<a class="code" href="structs_mcid.html#a064efb0868d3874ff175eb9eb9633449">bPolling</a>)
<a name="l00883"></a>00883         <a class="code" href="group__mcid__functions.html#ga8b24d6b7cbfd7240dc23dbd4c6759975">MCID_Handler</a>(pMcid);
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     <span class="keywordflow">if</span> (pMcid-&gt;<a class="code" href="structs_mcid.html#ac3c3f5e83be107e79ec82ad2f9a98161">bState</a> == <a class="code" href="group__mcid__defines.html#gae74337ed26d19d98b730bbf3f11cc00c">MCID_CMD</a>)
<a name="l00886"></a>00886         <span class="keywordflow">return</span> 0;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888     <span class="keywordflow">if</span> (pCmd)
<a name="l00889"></a>00889         <span class="keywordflow">return</span> 0;
<a name="l00890"></a>00890 
<a name="l00891"></a>00891     <span class="keywordflow">return</span> 1;
<a name="l00892"></a>00892 }
<a name="l00893"></a>00893 <span class="comment"></span>
<a name="l00894"></a>00894 <span class="comment">/**</span>
<a name="l00895"></a>00895 <span class="comment"> * IO control functions</span>
<a name="l00896"></a>00896 <span class="comment"> */</span>
<a name="l00897"></a><a class="code" href="group__mcid__functions.html#ga26e85daa2248e83129b01f755b1cfc0b">00897</a> uint32_t <a class="code" href="group__mcid__functions.html#ga26e85daa2248e83129b01f755b1cfc0b">MCID_IOCtrl</a>(<a class="code" href="structs_mcid.html" title="MCI Driver.">sMcid</a> *pMcid, uint32_t bCtl, uint32_t param)
<a name="l00898"></a>00898 {
<a name="l00899"></a>00899     <a class="code" href="struct_hsmci.html" title="Hsmci hardware registers.">Hsmci</a> *pMciHw = pMcid-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>;
<a name="l00900"></a>00900     assert(pMcid);
<a name="l00901"></a>00901     assert(pMcid-&gt;<a class="code" href="structs_mcid.html#a371eb28a9dd08c6de0266e2426d3a3e0">pMciHw</a>);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903     <span class="comment">//mciDis = _PeripheralEnable(pMcid-&gt;bID);</span>
<a name="l00904"></a>00904 
<a name="l00905"></a>00905     <span class="keywordflow">switch</span> (bCtl) {
<a name="l00906"></a>00906     <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__ioctrls.html#ga7bb7e8f4e4ef84955807f44575168b75">SDMMC_IOCTL_BUSY_CHECK</a>:
<a name="l00907"></a>00907         *(uint32_t *)param = !<a class="code" href="group__mcid__functions.html#gae956aa6961d961be8d3791413d81497f">MCID_IsCmdCompleted</a>(pMcid);
<a name="l00908"></a>00908         <span class="keywordflow">break</span>;
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__ioctrls.html#ga00a82889490184427b3ef522b9d996da">SDMMC_IOCTL_POWER</a>:
<a name="l00911"></a>00911         <span class="keywordflow">return</span> SDMMC_ERROR_NOT_SUPPORT;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913     <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__ioctrls.html#ga2e2c99dd4d77a71508586530d77343be">SDMMC_IOCTL_RESET</a>:
<a name="l00914"></a>00914         <a class="code" href="group__mcid__functions.html#ga03c7b7af1b4abf00f759b0a47c476baf">MCID_Reset</a>(pMcid);
<a name="l00915"></a>00915         <span class="keywordflow">return</span> SDMMC_SUCCESS;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917     <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__ioctrls.html#gab816e5258f956756f6e4d22cbb4601e1">SDMMC_IOCTL_CANCEL_CMD</a>:
<a name="l00918"></a>00918         <span class="keywordflow">return</span> <a class="code" href="group__mcid__functions.html#gaa42ae91258675d685937a68c69b2afdf">MCID_CancelCmd</a>(pMcid);
<a name="l00919"></a>00919 
<a name="l00920"></a>00920     <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__ioctrls.html#ga6f4117ae38fea45c18cc4aa6a8720429">SDMMC_IOCTL_SET_CLOCK</a>:
<a name="l00921"></a>00921         *(uint32_t *)param = MCI_SetSpeed(pMcid,
<a name="l00922"></a>00922                                           *(uint32_t *)param,
<a name="l00923"></a>00923                                           pMcid-&gt;<a class="code" href="structs_mcid.html#aeaec6201b5c461e5759994fc3c1b1d9b">dwMck</a>);
<a name="l00924"></a>00924         <span class="keywordflow">break</span>;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926     <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__ioctrls.html#gab9257a92d6eadac1483f6c375021050b">SDMMC_IOCTL_SET_HSMODE</a>:
<a name="l00927"></a>00927         <a class="code" href="group__hsmci__functions.html#ga9365f2817b47644f8c0f325a915fb141" title="Enable/Disable High-Speed mode for MCI.">HSMCI_HsEnable</a>(pMciHw, *(uint32_t *)param);
<a name="l00928"></a>00928         *(uint32_t *)param = <a class="code" href="group__hsmci__functions.html#gad4ba27f7339c9558b66aef5d9ebf6cab" title="Check if High-speed mode is enabled on MCI.">HSMCI_IsHsEnabled</a>(pMciHw);
<a name="l00929"></a>00929 
<a name="l00930"></a>00930         <span class="keywordflow">break</span>;
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__ioctrls.html#gafc5e89aaa94cd7945ce3016ce17487d3">SDMMC_IOCTL_SET_BUSMODE</a>:
<a name="l00933"></a>00933         <a class="code" href="group__hsmci__functions.html#ga402f687cf0393baac08390e517e84033" title="Set bus width of MCI.">HSMCI_SetBusWidth</a>(pMciHw, *(uint32_t *)param);
<a name="l00934"></a>00934         <span class="keywordflow">break</span>;
<a name="l00935"></a>00935 
<a name="l00936"></a>00936     <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__ioctrls.html#gab6c9a80f8e57bdfd35e753e6d458d2b1">SDMMC_IOCTL_GET_BUSMODE</a>:
<a name="l00937"></a>00937         <span class="comment">//*(uint32_t*)param = 8; /* Max 4-bit bus */</span>
<a name="l00938"></a>00938         <span class="keywordflow">break</span>;
<a name="l00939"></a>00939 
<a name="l00940"></a>00940     <span class="keywordflow">case</span> <a class="code" href="group__sdmmc__ioctrls.html#gae93102dfa081f624d2a4cf100013e4a2">SDMMC_IOCTL_GET_HSMODE</a>:
<a name="l00941"></a>00941         *(uint32_t *)param = 1; <span class="comment">/* Supported */</span>
<a name="l00942"></a>00942         <span class="keywordflow">break</span>;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944     <span class="keywordflow">default</span>:
<a name="l00945"></a>00945         <span class="keywordflow">return</span> SDMMC_ERROR_NOT_SUPPORT;
<a name="l00946"></a>00946     }
<a name="l00947"></a>00947 
<a name="l00948"></a>00948     <span class="keywordflow">return</span> SDMMC_OK;
<a name="l00949"></a>00949 }
<a name="l00950"></a>00950 <span class="comment"></span>
<a name="l00951"></a>00951 <span class="comment">/**</span>
<a name="l00952"></a>00952 <span class="comment"> * Initialize the SD/MMC card driver structure for SD/MMC bus mode</span>
<a name="l00953"></a>00953 <span class="comment"> * \note defined in SD/MMC bus mode low level (Here uses MCI interface)</span>
<a name="l00954"></a>00954 <span class="comment"> */</span>
<a name="l00955"></a><a class="code" href="group__sdmmc__hal.html#gacd612a6e4f21dcd32b36d244381473d2">00955</a> <span class="keywordtype">void</span> <a class="code" href="group__mcid__functions.html#gacd612a6e4f21dcd32b36d244381473d2">SDD_InitializeSdmmcMode</a>(<a class="code" href="structs_sd_card.html" title="SD/MMC card driver structure. It holds the current command being processed and the SD/MMC card addres...">sSdCard</a> *pSd, <span class="keywordtype">void</span> *pDrv, uint8_t <a class="code" href="cciddriver_8h.html#ac45819be33e5342f51430d69f2d7d474">bSlot</a>)
<a name="l00956"></a>00956 {
<a name="l00957"></a>00957     <a class="code" href="group__sdmmc__hal.html#gae72cb8a7a8d30d9193333928ff9be2b7">SDD_Initialize</a>(pSd, pDrv, bSlot, &amp;sdHal);
<a name="l00958"></a>00958 }
<a name="l00959"></a>00959 <span class="comment"></span>
<a name="l00960"></a>00960 <span class="comment">/**@}*/</span>
</pre></div></div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
